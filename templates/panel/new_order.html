{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "New Order" %} - VinFlow{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header with Balance -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
        <h1 class="text-3xl font-bold">{% trans "Create New Order" %}</h1>
            <p class="text-gray-400 mt-1">{% trans "Select a service and place your order" %}</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="bg-slate-800/50 rounded-lg px-4 py-2 border border-slate-700">
                <div class="text-xs text-gray-400">{% trans "Balance" %}</div>
                <div class="text-xl font-bold text-cyan-400">${{ user_balance|floatformat:2 }}</div>
            </div>
            <a href="{% url 'orders' %}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">
            {% trans "View Orders" %}
        </a>
        </div>
    </div>
    
    <!-- Progress Steps -->
    <div class="card-glass rounded-xl p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-2 flex-1">
                <div class="step-indicator active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">{% trans "Platform" %}</div>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">{% trans "Service" %}</div>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">{% trans "Details" %}</div>
                </div>
                <div class="step-line"></div>
                <div class="step-indicator" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">{% trans "Review" %}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Promotions Banner -->
    {% include 'panel/partials/promotion_banner.html' with location='checkout' %}
    
    <!-- Platform Selection -->
    <div class="card-glass rounded-xl p-6" id="step1">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            {% trans "Select Platform" %}
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button onclick="selectPlatform('all')" id="platform-all" class="platform-btn platform-active p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <span class="font-semibold">{% trans "Everything" %}</span>
            </button>
            <button onclick="selectPlatform('tt')" id="platform-tt" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                </svg>
                <span class="font-semibold">TikTok</span>
            </button>
            <button onclick="selectPlatform('yt')" id="platform-yt" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                <span class="font-semibold">YouTube</span>
            </button>
            <button onclick="selectPlatform('tg')" id="platform-tg" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                </svg>
                <span class="font-semibold">Telegram</span>
            </button>
            <button onclick="selectPlatform('ig')" id="platform-ig" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
                <span class="font-semibold">Instagram</span>
            </button>
            <button onclick="selectPlatform('fb')" id="platform-fb" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
                <span class="font-semibold">Facebook</span>
            </button>
            <button onclick="selectPlatform('tw')" id="platform-tw" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
                <span class="font-semibold">Twitter/X</span>
            </button>
            <button onclick="selectPlatform('sp')" id="platform-sp" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66.06 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.42 1.56-.299.421-1.02.599-1.559.3z"/>
                </svg>
                <span class="font-semibold">Spotify</span>
            </button>
        </div>
    </div>
    
    <!-- Order Form -->
    <div class="card-glass rounded-xl p-6" id="step2">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                {% trans "Order Details" %}
            </h2>
            <button onclick="window.open('https://youtu.be/example', '_blank')" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm flex items-center gap-2 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                </svg>
                {% trans "Video Tutorial" %}
            </button>
        </div>
        
        <form method="post" action="{% url 'create_order' %}" id="orderForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- Search Services -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    {% trans "Search Services" %}
                </label>
                <input type="text" id="searchInput" placeholder="{% trans 'Search services...' %}" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition">
            </div>
            
            <!-- Category Selection -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    {% trans "Category" %}
                </label>
                <select id="categorySelect" onchange="filterServices()" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition">
                    <option value="">{% trans "All Categories" %}</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">
                            {% if is_khmer %}{{ category.name_km|default:category.name }}{% else %}{{ category.name }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Service Selection -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    {% trans "Service" %} <span class="text-red-400">*</span>
                </label>
                <input type="hidden" name="service_id" id="service_id" required>
                <div id="servicesContainer" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                    {% for service in services %}
                        <div class="service-card p-4 border-2 border-slate-700 rounded-lg hover:border-purple-500 cursor-pointer transition"
                             data-service-id="{{ service.id }}"
                             data-platform="{{ service.service_type }}"
                             data-category="{{ service.category.id|default:'' }}"
                             data-name="{{ service.name|lower }}"
                             data-rate="{{ service.rate }}"
                             data-min="{{ service.min_order }}"
                             data-max="{{ service.max_order }}"
                             data-drip="{{ service.drip_feed_enabled|yesno:'true,false' }}"
                             onclick="selectService(this)">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg">
                                        <span class="text-cyan-400">{{ service.external_service_id }}</span>
                                        - {% if is_khmer %}{{ service.name_km|default:service.name }}{% else %}{{ service.name }}{% endif %}
                                        {% if service.drip_feed_enabled %}
                                            <span class="text-xs px-2 py-1 bg-yellow-900/50 text-yellow-400 rounded ml-2 inline-flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                                                </svg>
                                                SuperFast
                                            </span>
                                        {% endif %}
                                        <span class="text-xs px-2 py-1 bg-green-900/50 text-green-400 rounded ml-2 inline-flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            </svg>
                                            Ultrafast Completed
                                        </span>
                                    </h3>
                                    <p class="text-sm text-gray-400 mt-1">
                                        {% if is_khmer %}{{ service.description_km|default:service.description|truncatewords:20 }}{% else %}{{ service.description|truncatewords:20 }}{% endif %}
                                    </p>
                                </div>
                                <div class="text-right ml-4">
                                    <div class="text-cyan-400 font-bold">${{ service.rate|floatformat:4 }}/1K</div>
                                    <div class="text-xs text-gray-400">Min: {{ service.min_order }}</div>
                                    <div class="text-xs text-gray-400">Max: {{ service.max_order }}</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-400 mt-2" id="serviceInfo">{% trans "Please select a service" %}</p>
                <p class="text-xs text-red-400 mt-1 hidden" id="serviceError">{% trans "Please select a service to continue" %}</p>
            </div>
            
            <!-- Step 3: Order Details -->
            <div id="step3" class="space-y-6 hidden">
            <!-- Link Input -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    {% trans "Link" %} <span class="text-red-400">*</span>
                </label>
                    <input type="url" name="link" id="linkInput" required placeholder="https://..." class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition">
                    <p class="text-xs text-gray-400 mt-1">{% trans "Enter the URL of the content you want to promote" %}</p>
                    <p class="text-xs text-red-400 mt-1 hidden" id="linkError">{% trans "Please enter a valid URL" %}</p>
            </div>
            
                <!-- Quantity Input with Quick Buttons -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    {% trans "Quantity" %} <span class="text-red-400">*</span>
                </label>
                    <div class="flex gap-2 mb-2">
                        <button type="button" onclick="setQuickQuantity(100)" class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded transition">100</button>
                        <button type="button" onclick="setQuickQuantity(500)" class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded transition">500</button>
                        <button type="button" onclick="setQuickQuantity(1000)" class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded transition">1K</button>
                        <button type="button" onclick="setQuickQuantity(5000)" class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded transition">5K</button>
                        <button type="button" onclick="setQuickQuantity(10000)" class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded transition">10K</button>
                    </div>
                    <input type="number" name="quantity" id="quantityInput" required min="1" placeholder="100" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition" oninput="updateCharge()">
                <p class="text-xs text-gray-400 mt-1" id="quantityRange">{% trans "Min: 5 - Max: 20,000,000" %}</p>
                    <p class="text-xs text-red-400 mt-1 hidden" id="quantityError"></p>
            </div>
            
            <!-- Average Time -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    {% trans "Average time" %}
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </label>
                <div class="bg-slate-700/30 border border-slate-600 rounded-lg px-4 py-3 text-gray-400">
                        <span id="avgTime">-</span>
                </div>
            </div>
            
            <!-- Drip Feed Options (Hidden by default) -->
            <div id="dripFeedSection" class="hidden space-y-4">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" name="drip_feed" id="drip_feed" class="rounded">
                    <label for="drip_feed" class="text-sm font-medium">{% trans "Enable Drip-Feed (Spread delivery over multiple days)" %}</label>
                </div>
                    <div id="dripFeedOptions" class="hidden">
                        <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm mb-2">{% trans "Quantity per day" %}</label>
                                <input type="number" name="drip_feed_quantity" id="drip_feed_quantity" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2" min="1">
                    </div>
                    <div>
                        <label class="block text-sm mb-2">{% trans "Number of days" %}</label>
                                <input type="number" name="drip_feed_days" id="drip_feed_days" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2" min="1">
                            </div>
                    </div>
                </div>
            </div>
            
                <!-- Coupon Code with Real-time Validation -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                    </svg>
                    {% trans "Coupon Code (Optional)" %}
                </label>
                    <div class="flex gap-2">
                        <input type="text" name="coupon_code" id="couponInput" placeholder="VINOPENING" class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none transition" onblur="validateCoupon()">
                        <button type="button" onclick="validateCoupon()" class="px-4 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm transition">
                            {% trans "Apply" %}
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1" id="couponMessage"></p>
                    <p class="text-xs text-green-400 mt-1 hidden" id="couponSuccess"></p>
                    <p class="text-xs text-red-400 mt-1 hidden" id="couponError"></p>
                </div>
            </div>
            
            <!-- Step 4: Order Summary -->
            <div id="step4" class="hidden border-t border-slate-700 pt-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    {% trans "Order Summary" %}
                </h3>
                <div class="bg-slate-800/50 rounded-lg p-4 space-y-3 mb-6">
                    <div class="flex justify-between">
                        <span class="text-gray-400">{% trans "Service" %}:</span>
                        <span id="summaryService" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">{% trans "Link" %}:</span>
                        <span id="summaryLink" class="font-semibold text-sm break-all text-right max-w-xs">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">{% trans "Quantity" %}:</span>
                        <span id="summaryQuantity" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">{% trans "Rate" %}:</span>
                        <span id="summaryRate" class="font-semibold">-</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-700 pt-2">
                        <span class="text-gray-400">{% trans "Subtotal" %}:</span>
                        <span id="summarySubtotal" class="font-semibold">$0.00</span>
                    </div>
                    <div class="flex justify-between" id="summaryDiscountRow" style="display: none;">
                        <span class="text-green-400">{% trans "Discount" %}:</span>
                        <span id="summaryDiscount" class="font-semibold text-green-400">-$0.00</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-700 pt-2">
                        <span class="text-lg text-gray-300">{% trans "Total Charge" %}:</span>
                        <span class="text-2xl font-bold text-cyan-400" id="totalCharge">$0.00</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-700 pt-2">
                        <span class="text-gray-400">{% trans "Your Balance" %}:</span>
                        <span id="summaryBalance" class="font-semibold">${{ user_balance|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between" id="balanceWarning" style="display: none;">
                        <span class="text-red-400 text-sm">{% trans "After Order" %}:</span>
                        <span id="summaryAfterBalance" class="font-semibold text-red-400">-</span>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-4 rounded-lg text-lg transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    {% trans "Place Order" %}
                </button>
                <p class="text-xs text-center text-gray-400 mt-2">{% trans "By placing this order, you agree to our terms of service" %}</p>
            </div>
        </form>
    </div>
</div>

<style>
.platform-active {
    border-color: #a855f7 !important;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
}

.service-card.selected {
    border-color: #a855f7 !important;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
}

.service-card.hidden {
    display: none;
}

.step-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    position: relative;
}

.step-number {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    background: rgba(51, 65, 85, 0.5);
    border: 2px solid #475569;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #94a3b8;
    transition: all 0.3s;
}

.step-indicator.active .step-number {
    background: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);
    border-color: #a855f7;
    color: white;
    transform: scale(1.1);
}

.step-label {
    font-size: 0.75rem;
    color: #94a3b8;
    text-align: center;
}

.step-indicator.active .step-label {
    color: #a855f7;
    font-weight: 600;
}

.step-line {
    flex: 1;
    height: 2px;
    background: #475569;
    margin: 0 0.5rem;
    margin-top: -1.25rem;
}

.step-indicator.active ~ .step-line {
    background: linear-gradient(90deg, #a855f7 0%, #3b82f6 100%);
}

.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(51, 65, 85, 0.5);
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #475569;
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #64748b;
}
</style>

<script>
let currentRate = 0;
let minOrder = 1;
let maxOrder = 100000;
let selectedPlatform = 'all';
let selectedService = null;
let couponDiscount = 0;
let userBalance = parseFloat('{{ user_balance|default:0 }}') || 0;

// Platform Selection
function selectPlatform(platform) {
    selectedPlatform = platform;
    
    // Update UI
    document.querySelectorAll('.platform-btn').forEach(btn => {
        btn.classList.remove('platform-active');
    });
    document.getElementById('platform-' + platform).classList.add('platform-active');
    
    // Filter services
    filterServices();
    updateStep(1);
}

// Service Selection
function selectService(element) {
    // Remove previous selection
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection
    element.classList.add('selected');
    selectedService = element;
    
    // Set values
    const serviceId = element.dataset.serviceId;
    const rate = parseFloat(element.dataset.rate);
    const min = parseInt(element.dataset.min);
    const max = parseInt(element.dataset.max);
    const dripEnabled = element.dataset.drip === 'true';
    
    document.getElementById('service_id').value = serviceId;
    currentRate = rate;
    minOrder = min;
    maxOrder = max;
    
    // Update quantity range
    document.getElementById('quantityRange').textContent = `{% trans "Min" %}: ${min.toLocaleString()} - {% trans "Max" %}: ${max.toLocaleString()}`;
    document.getElementById('quantityInput').min = min;
    document.getElementById('quantityInput').max = max;
    
    // Show/hide drip feed
    if (dripEnabled) {
        document.getElementById('dripFeedSection').classList.remove('hidden');
    } else {
        document.getElementById('dripFeedSection').classList.add('hidden');
    }
    
    // Update service info
    document.getElementById('serviceInfo').textContent = element.querySelector('h3').textContent.trim();
    document.getElementById('serviceError').classList.add('hidden');
    
    // Show step 3
    document.getElementById('step3').classList.remove('hidden');
    updateStep(2);
    
    // Scroll to details
    setTimeout(() => {
        document.getElementById('linkInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
    
    // Update charge
    updateCharge();
}

// Filter Services
function filterServices() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categorySelect').value;
    
    let visibleCount = 0;
    document.querySelectorAll('.service-card').forEach(card => {
        const cardPlatform = card.dataset.platform;
        const cardCategory = card.dataset.category;
        const cardName = card.dataset.name;
        
        let show = true;
        
        // Platform filter
        if (selectedPlatform !== 'all' && cardPlatform !== selectedPlatform) {
            show = false;
        }
        
        // Category filter
        if (category && cardCategory !== category) {
            show = false;
        }
        
        // Search filter
        if (searchTerm && !cardName.includes(searchTerm)) {
            show = false;
        }
        
        if (show) {
            card.classList.remove('hidden');
            visibleCount++;
        } else {
            card.classList.add('hidden');
        }
    });
    
    // Show message if no services found
    if (visibleCount === 0) {
        const container = document.getElementById('servicesContainer');
        if (!container.querySelector('.no-services-message')) {
            const message = document.createElement('div');
            message.className = 'no-services-message text-center py-8 text-gray-400';
            message.textContent = '{% trans "No services found. Try adjusting your filters." %}';
            container.appendChild(message);
        }
    } else {
        const message = container.querySelector('.no-services-message');
        if (message) message.remove();
    }
}

// Quick Quantity Buttons
function setQuickQuantity(qty) {
    const input = document.getElementById('quantityInput');
    const qtyNum = Math.max(minOrder, Math.min(maxOrder, qty));
    input.value = qtyNum;
    updateCharge();
}

// Update Charge
function updateCharge() {
    const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
    const charge = (currentRate / 1000) * quantity;
    const finalCharge = Math.max(0, charge - couponDiscount);
    
    document.getElementById('totalCharge').textContent = '$' + finalCharge.toFixed(2);
    
    // Update summary
    updateOrderSummary();
    
    // Validate quantity
    validateQuantity(quantity);
    
    // Check balance
    checkBalance(finalCharge);
}

// Validate Quantity
function validateQuantity(quantity) {
    const errorEl = document.getElementById('quantityError');
    if (quantity < minOrder || quantity > maxOrder) {
        errorEl.textContent = `{% trans "Quantity must be between" %} ${minOrder.toLocaleString()} {% trans "and" %} ${maxOrder.toLocaleString()}`;
        errorEl.classList.remove('hidden');
        return false;
    } else {
        errorEl.classList.add('hidden');
        return true;
    }
}

// Check Balance
function checkBalance(charge) {
    const warningEl = document.getElementById('balanceWarning');
    const afterBalanceEl = document.getElementById('summaryAfterBalance');
    const submitBtn = document.getElementById('submitBtn');
    
    if (userBalance < charge) {
        const afterBalance = userBalance - charge;
        afterBalanceEl.textContent = '$' + afterBalance.toFixed(2);
        warningEl.style.display = 'flex';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg> {% trans "Insufficient Balance" %}';
    } else {
        warningEl.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> {% trans "Place Order" %}';
    }
}

// Validate Coupon
function validateCoupon() {
    const couponCode = document.getElementById('couponInput').value.trim().toUpperCase();
    const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
    const charge = (currentRate / 1000) * quantity;
    
    if (!couponCode) {
        document.getElementById('couponMessage').textContent = '';
        document.getElementById('couponSuccess').classList.add('hidden');
        document.getElementById('couponError').classList.add('hidden');
        couponDiscount = 0;
        updateCharge();
        return;
    }
    
    // Show loading
    document.getElementById('couponMessage').textContent = '{% trans "Validating coupon..." %}';
    document.getElementById('couponSuccess').classList.add('hidden');
    document.getElementById('couponError').classList.add('hidden');
    
    // AJAX request
    const formData = new FormData();
    formData.append('coupon_code', couponCode);
    formData.append('charge', charge);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "validate_coupon" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('couponMessage').textContent = '';
        if (data.status === 'success') {
            couponDiscount = data.discount;
            document.getElementById('couponSuccess').textContent = data.message;
            document.getElementById('couponSuccess').classList.remove('hidden');
            document.getElementById('couponError').classList.add('hidden');
        } else {
            couponDiscount = 0;
            document.getElementById('couponError').textContent = data.message;
            document.getElementById('couponError').classList.remove('hidden');
            document.getElementById('couponSuccess').classList.add('hidden');
        }
        updateCharge();
    })
    .catch(error => {
        document.getElementById('couponMessage').textContent = '';
        document.getElementById('couponError').textContent = '{% trans "Error validating coupon. Please try again." %}';
        document.getElementById('couponError').classList.remove('hidden');
        couponDiscount = 0;
        updateCharge();
    });
}

// Update Order Summary
function updateOrderSummary() {
    const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
    const link = document.getElementById('linkInput').value || '-';
    const charge = (currentRate / 1000) * quantity;
    const finalCharge = Math.max(0, charge - couponDiscount);
    
    if (selectedService) {
        document.getElementById('summaryService').textContent = selectedService.querySelector('h3').textContent.trim();
    }
    document.getElementById('summaryLink').textContent = link.length > 50 ? link.substring(0, 50) + '...' : link;
    document.getElementById('summaryQuantity').textContent = quantity.toLocaleString();
    document.getElementById('summaryRate').textContent = '$' + currentRate.toFixed(4) + '/1K';
    document.getElementById('summarySubtotal').textContent = '$' + charge.toFixed(2);
    
    if (couponDiscount > 0) {
        document.getElementById('summaryDiscount').textContent = '-$' + couponDiscount.toFixed(2);
        document.getElementById('summaryDiscountRow').style.display = 'flex';
    } else {
        document.getElementById('summaryDiscountRow').style.display = 'none';
    }
    
    // Show step 4 when all required fields are filled
    if (document.getElementById('service_id').value && 
        document.getElementById('linkInput').value && 
        quantity >= minOrder && quantity <= maxOrder) {
        document.getElementById('step4').classList.remove('hidden');
        updateStep(3);
    }
}

// Update Step Indicator
function updateStep(step) {
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        if (index + 1 <= step) {
            indicator.classList.add('active');
        } else {
            indicator.classList.remove('active');
        }
    });
}

// Form Validation
document.getElementById('orderForm').addEventListener('submit', function(e) {
    const serviceId = document.getElementById('service_id').value;
    if (!serviceId) {
        e.preventDefault();
        document.getElementById('serviceError').classList.remove('hidden');
        document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
        return false;
    }
    
    const quantity = parseInt(document.getElementById('quantityInput').value);
    if (!validateQuantity(quantity)) {
        e.preventDefault();
        document.getElementById('quantityInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    const link = document.getElementById('linkInput').value;
    if (!link) {
        e.preventDefault();
        document.getElementById('linkError').classList.remove('hidden');
        document.getElementById('linkInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    const finalCharge = (currentRate / 1000) * quantity - couponDiscount;
    if (userBalance < finalCharge) {
        e.preventDefault();
        alert('{% trans "Insufficient balance. Please top up your account." %}');
        return false;
    }
});

// Search Input Event
document.getElementById('searchInput').addEventListener('input', filterServices);

// Quantity Input Event
document.getElementById('quantityInput').addEventListener('input', function() {
    updateCharge();
    updateOrderSummary();
});

// Link Input Event
document.getElementById('linkInput').addEventListener('input', function() {
    document.getElementById('linkError').classList.add('hidden');
    updateOrderSummary();
});

// Drip Feed Toggle
document.getElementById('drip_feed').addEventListener('change', function() {
    document.getElementById('dripFeedOptions').classList.toggle('hidden', !this.checked);
});

// Initialize
filterServices();
updateStep(1);
</script>
{% endblock %}
