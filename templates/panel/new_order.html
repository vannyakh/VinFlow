{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "New Order" %} - VinFlow{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-4 md:space-y-6 px-3 md:px-0">
    <!-- Header with Balance - Sticky on Mobile -->
    <div class="sticky top-0 z-40 bg-slate-900/95 backdrop-blur-sm -mx-3 px-3 md:mx-0 md:px-0 py-3 md:py-0 md:static flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-4">
        <div>
        <h1 class="text-2xl md:text-3xl font-bold">{% trans "Create New Order" %}</h1>
            <p class="text-gray-400 mt-1 text-sm md:text-base">{% trans "Select a service and place your order" %}</p>
        </div>
        <div class="flex items-center gap-2 md:gap-4 w-full md:w-auto">
            <div class="bg-slate-800/50 rounded-lg px-3 md:px-4 py-2 border border-slate-700 flex-1 md:flex-initial">
                <div class="text-xs text-gray-400">{% trans "Balance" %}</div>
                <div class="text-lg md:text-xl font-bold text-cyan-400">${{ user_balance|floatformat:2 }}</div>
            </div>
            <a href="{% url 'orders' %}" class="px-3 md:px-4 py-2 bg-slate-700 hover:bg-slate-600 active:bg-slate-500 rounded-lg text-sm transition whitespace-nowrap">
            {% trans "View Orders" %}
        </a>
        </div>
    </div>
    
    <!-- Promotions Banner -->
    {% include 'panel/partials/promotion_banner.html' with location='checkout' %}
    
    <!-- Platform Selection -->
    <div class="card-glass rounded-xl p-4 md:p-6" id="step1">
        <h2 class="text-lg md:text-xl font-semibold mb-3 md:mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            {% trans "Select Platform" %}
        </h2>
        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-3">
            <button onclick="selectPlatform('all')" id="platform-all" class="platform-btn p-3 md:p-4 rounded-lg border-2 border-slate-700 active:scale-95 transition-all flex flex-col items-center gap-1 md:gap-2 min-h-[80px] md:min-h-[90px]">
                <svg class="w-7 h-7 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <span class="font-semibold text-xs md:text-sm">{% trans "All" %}</span>
            </button>
            {% for network in social_networks %}
            <button onclick="selectPlatform('{{ network.platform_code }}')" id="platform-{{ network.platform_code }}" class="platform-btn p-3 md:p-4 rounded-lg border-2 border-slate-700 active:scale-95 transition-all flex flex-col items-center gap-1 md:gap-2 min-h-[80px] md:min-h-[90px]">
                {% if network.icon_image %}
                    <img src="{{ network.icon_image.url }}" alt="{{ network.name }}" class="w-7 h-7 md:w-8 md:h-8 object-contain">
                {% elif network.icon %}
                    <i class="{{ network.icon }} text-2xl md:text-3xl" style="color: {{ network.color }}"></i>
                {% else %}
                    <i class="{{ network.get_icon_class }} text-2xl md:text-3xl" style="color: {{ network.color }}"></i>
                {% endif %}
                <span class="font-semibold text-xs md:text-sm text-center leading-tight">
                    {% if is_khmer %}{{ network.name_km|default:network.name }}{% else %}{{ network.name }}{% endif %}
                </span>
            </button>
            {% endfor %}
        </div>
    </div>
    
    <!-- Order Form -->
    <div class="card-glass rounded-xl p-4 md:p-6" id="step2">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 md:mb-6">
            <h2 class="text-lg md:text-xl font-semibold flex items-center gap-2">
                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                {% trans "Order Details" %}
            </h2>
            <button onclick="window.open('https://youtu.be/example', '_blank')" class="px-3 md:px-4 py-2 bg-blue-600 hover:bg-blue-500 active:bg-blue-700 rounded-lg text-xs md:text-sm flex items-center gap-2 transition">
                <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                </svg>
                <span class="hidden sm:inline">{% trans "Video Tutorial" %}</span>
                <span class="sm:hidden">{% trans "Tutorial" %}</span>
            </button>
        </div>
        
        <form method="post" action="{% url 'create_order' %}" id="orderForm" class="space-y-4 md:space-y-6">
            {% csrf_token %}
            
            <!-- Search Services -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    {% trans "Search Services" %}
                </label>
                <input type="text" id="searchInput" placeholder="{% trans 'Search services...' %}" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 md:py-3 text-base focus:border-purple-500 focus:outline-none transition">
            </div>
            
            <!-- Category Selection -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    {% trans "Category" %}
                </label>
                
                <!-- Hidden select for form submission -->
                <select id="categorySelect" onchange="filterServices()" class="hidden">
                    {% for category in categories %}
                        <option value="{{ category.id }}" 
                                data-platform="{{ category.social_network.platform_code|default:'' }}"
                                data-social-network="{{ category.social_network.id|default:'' }}">
                            {% if category.social_network %}[{{ category.social_network.name }}] {% endif %}{% if is_khmer %}{{ category.name_km|default:category.name }}{% else %}{{ category.name }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
                
                <!-- Custom dropdown display -->
                <div class="relative">
                    <div id="categoryDisplay" onclick="toggleCategoryDropdown()" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 cursor-pointer flex items-center justify-between active:bg-slate-600/50 transition">
                        <div id="selectedCategoryDisplay" class="flex items-center gap-2 text-base">
                            <span class="text-gray-400">{% trans "Select Category" %}</span>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transition-transform flex-shrink-0" id="categoryDropdownArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    
                    <!-- Dropdown menu -->
                    <div id="categoryDropdownMenu" class="hidden fixed md:absolute z-50 left-3 right-3 md:left-auto md:right-auto md:w-full mt-2 bg-slate-700 border border-slate-600 rounded-lg shadow-xl max-h-[60vh] md:max-h-96 overflow-y-auto custom-scrollbar">
                        <div class="p-2">
                            {% for category in categories %}
                            <div onclick="selectCategory('{{ category.id }}', this)" 
                                 class="category-option p-4 md:p-3 rounded active:bg-slate-500 cursor-pointer transition {% if forloop.first %}category-first{% endif %}"
                                 data-platform="{{ category.social_network.platform_code|default:'' }}"
                                 data-social-network="{{ category.social_network.id|default:'' }}"
                                 data-category-id="{{ category.id }}">
                                <div class="flex items-center gap-3">
                                    {% if category.social_network %}
                                        {% if category.social_network.icon_image %}
                                            <img src="{{ category.social_network.icon_image.url }}" alt="{{ category.social_network.name }}" class="w-6 h-6 md:w-5 md:h-5 object-contain flex-shrink-0">
                                        {% elif category.social_network.icon %}
                                            <i class="{{ category.social_network.icon }} text-xl md:text-lg flex-shrink-0" style="color: {{ category.social_network.color }}"></i>
                                        {% else %}
                                            <i class="{{ category.social_network.get_icon_class }} text-xl md:text-lg flex-shrink-0" style="color: {{ category.social_network.color }}"></i>
                                        {% endif %}
                                    {% else %}
                                        <div class="w-6 h-6 md:w-5 md:h-5 flex-shrink-0"></div>
                                    {% endif %}
                                    <div class="min-w-0 flex-1">
                                        <div class="font-medium text-white text-base md:text-sm">
                                            {% if is_khmer %}{{ category.name_km|default:category.name }}{% else %}{{ category.name }}{% endif %}
                                        </div>
                                        {% if category.social_network %}
                                        <div class="text-xs text-gray-400">{{ category.social_network.name }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Service Selection -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    {% trans "Service" %} <span class="text-red-400">*</span>
                </label>
                <input type="hidden" name="service_id" id="service_id" required>
                <div id="servicesContainer" class="space-y-2 max-h-[50vh] md:max-h-96 overflow-y-auto custom-scrollbar">
                    <!-- Waiting for category selection message -->
                    <div id="waitingCategoryMessage" class="text-center py-12 bg-slate-800/30 rounded-lg border-2 border-dashed border-slate-700">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                                </svg>
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">{% trans "Select a Category" %}</h3>
                        <p class="text-sm text-gray-400">{% trans "Please choose a category above to view available services" %}</p>
                                </div>
                    
                    <!-- Loading spinner -->
                    <div id="loadingServices" class="hidden text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent"></div>
                        <p class="text-gray-400 mt-4">{% trans "Loading services..." %}</p>
                                </div>
                    
                    <!-- Services will be dynamically loaded here -->
                            </div>
                <p class="text-xs text-gray-400 mt-2" id="serviceInfo">
                    <span id="serviceInfoText">{% trans "Select a category above to view available services" %}</span>
                </p>
                <p class="text-xs text-red-400 mt-1 hidden" id="serviceError">{% trans "Please select a service to continue" %}</p>
            </div>
            
            <!-- Step 3: Order Details -->
            <div id="step3" class="space-y-4 md:space-y-6 hidden">
            <!-- Link Input -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    {% trans "Link" %} <span class="text-red-400">*</span>
                </label>
                    <input type="url" name="link" id="linkInput" required placeholder="https://..." class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-base focus:border-purple-500 focus:outline-none transition">
                    <p class="text-xs text-gray-400 mt-1">{% trans "Enter the URL of the content you want to promote" %}</p>
                    <p class="text-xs text-red-400 mt-1 hidden" id="linkError">{% trans "Please enter a valid URL" %}</p>
            </div>
            
                <!-- Quantity Input with Quick Buttons -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    {% trans "Quantity" %} <span class="text-red-400">*</span>
                </label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button type="button" onclick="setQuickQuantity(100)" class="flex-1 min-w-[60px] px-3 py-2 text-sm bg-slate-700 hover:bg-slate-600 active:bg-slate-500 rounded transition">100</button>
                        <button type="button" onclick="setQuickQuantity(500)" class="flex-1 min-w-[60px] px-3 py-2 text-sm bg-slate-700 hover:bg-slate-600 active:bg-slate-500 rounded transition">500</button>
                        <button type="button" onclick="setQuickQuantity(1000)" class="flex-1 min-w-[60px] px-3 py-2 text-sm bg-slate-700 hover:bg-slate-600 active:bg-slate-500 rounded transition">1K</button>
                        <button type="button" onclick="setQuickQuantity(5000)" class="flex-1 min-w-[60px] px-3 py-2 text-sm bg-slate-700 hover:bg-slate-600 active:bg-slate-500 rounded transition">5K</button>
                        <button type="button" onclick="setQuickQuantity(10000)" class="flex-1 min-w-[60px] px-3 py-2 text-sm bg-slate-700 hover:bg-slate-600 active:bg-slate-500 rounded transition">10K</button>
                    </div>
                    <input type="number" name="quantity" id="quantityInput" required min="1" placeholder="100" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-base focus:border-purple-500 focus:outline-none transition" oninput="updateCharge()">
                <p class="text-xs text-gray-400 mt-1" id="quantityRange">{% trans "Min: 5 - Max: 20,000,000" %}</p>
                    <p class="text-xs text-red-400 mt-1 hidden" id="quantityError"></p>
            </div>
            
            <!-- Drip Feed Options (Hidden by default) -->
            <div id="dripFeedSection" class="hidden space-y-4">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" name="drip_feed" id="drip_feed" class="rounded w-5 h-5">
                    <label for="drip_feed" class="text-sm font-medium">{% trans "Enable Drip-Feed (Spread delivery over multiple days)" %}</label>
                </div>
                    <div id="dripFeedOptions" class="hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm mb-2">{% trans "Quantity per day" %}</label>
                                <input type="number" name="drip_feed_quantity" id="drip_feed_quantity" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-base" min="1">
                    </div>
                    <div>
                        <label class="block text-sm mb-2">{% trans "Number of days" %}</label>
                                <input type="number" name="drip_feed_days" id="drip_feed_days" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-base" min="1">
                            </div>
                    </div>
                </div>
            </div>
            
                <!-- Coupon Code with Real-time Validation -->
            <div>
                <label class="text-sm font-medium mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                    </svg>
                    {% trans "Coupon Code (Optional)" %}
                </label>
                    <div class="flex gap-2">
                        <input type="text" name="coupon_code" id="couponInput" placeholder="VINOPENING" class="flex-1 bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-base focus:border-purple-500 focus:outline-none transition" onblur="validateCoupon()">
                        <button type="button" onclick="validateCoupon()" class="px-4 md:px-6 py-3 bg-purple-600 hover:bg-purple-500 active:bg-purple-700 rounded-lg text-sm md:text-base transition whitespace-nowrap">
                            {% trans "Apply" %}
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1" id="couponMessage"></p>
                    <p class="text-xs text-green-400 mt-1 hidden" id="couponSuccess"></p>
                    <p class="text-xs text-red-400 mt-1 hidden" id="couponError"></p>
                </div>
            </div>
            
            <!-- Step 4: Order Summary -->
            <div id="step4" class="hidden border-t border-slate-700 pt-4 md:pt-6">
                <h3 class="text-base md:text-lg font-semibold mb-3 md:mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    {% trans "Order Summary" %}
                </h3>
                <div class="bg-slate-800/50 rounded-lg p-4 space-y-3 mb-6">
                    <div class="flex justify-between gap-4">
                        <span class="text-gray-400 text-sm">{% trans "Service" %}:</span>
                        <span id="summaryService" class="font-semibold text-sm text-right">-</span>
                    </div>
                    <div class="flex justify-between gap-4">
                        <span class="text-gray-400 text-sm flex-shrink-0">{% trans "Link" %}:</span>
                        <span id="summaryLink" class="font-semibold text-xs break-all text-right">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400 text-sm">{% trans "Quantity" %}:</span>
                        <span id="summaryQuantity" class="font-semibold text-sm">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400 text-sm">{% trans "Rate" %}:</span>
                        <span id="summaryRate" class="font-semibold text-sm">-</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-700 pt-3">
                        <span class="text-gray-400 text-sm">{% trans "Subtotal" %}:</span>
                        <span id="summarySubtotal" class="font-semibold">$0.00</span>
                    </div>
                    <div class="flex justify-between" id="summaryDiscountRow" style="display: none;">
                        <span class="text-green-400 text-sm">{% trans "Discount" %}:</span>
                        <span id="summaryDiscount" class="font-semibold text-green-400">-$0.00</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-700 pt-3">
                        <span class="text-base md:text-lg text-gray-300">{% trans "Total Charge" %}:</span>
                        <span class="text-xl md:text-2xl font-bold text-cyan-400" id="totalCharge">$0.00</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-700 pt-3">
                        <span class="text-gray-400 text-sm">{% trans "Your Balance" %}:</span>
                        <span id="summaryBalance" class="font-semibold">${{ user_balance|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between" id="balanceWarning" style="display: none;">
                        <span class="text-red-400 text-sm">{% trans "After Order" %}:</span>
                        <span id="summaryAfterBalance" class="font-semibold text-red-400">-</span>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 active:from-purple-700 active:to-blue-700 text-white font-bold py-4 rounded-lg text-base md:text-lg transition active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100 flex items-center justify-center gap-2 shadow-lg">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    {% trans "Place Order" %}
                </button>
                <p class="text-xs text-center text-gray-400 mt-3">{% trans "By placing this order, you agree to our terms of service" %}</p>
            </div>
        </form>
    </div>
</div>

<!-- Mobile Bottom Padding for Better Scrolling -->
<div class="h-20 md:hidden"></div>

<style>
/* Platform Selection */
.platform-active {
    border-color: #a855f7 !important;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
}

.platform-btn {
    -webkit-tap-highlight-color: transparent;
    position: relative;
}

/* Recent Platform Badge */
.recent-badge {
    animation: pulseGlow 2s ease-in-out infinite;
    font-size: 10px;
    z-index: 10;
}

@keyframes pulseGlow {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
    transform: scale(1.1);
        opacity: 0.8;
    }
}

/* Service Cards */
.service-card.selected {
    border-color: #a855f7 !important;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
}

.service-card.hidden {
    display: none;
}

.service-card {
    -webkit-tap-highlight-color: transparent;
}

/* Custom Scrollbar */
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

@media (min-width: 768px) {
.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
    }
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(51, 65, 85, 0.5);
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #475569;
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #64748b;
}

/* Category Dropdown */
.category-option.selected {
    background: rgba(168, 85, 247, 0.2);
    border-left: 3px solid #a855f7;
}

.category-option {
    -webkit-tap-highlight-color: transparent;
}

#categoryDropdownMenu {
    animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Mobile Input Fixes */
@media (max-width: 768px) {
    /* Prevent zoom on input focus on iOS */
    input[type="text"],
    input[type="url"],
    input[type="number"],
    select,
    textarea {
        font-size: 16px !important;
    }
    
    /* Better touch targets */
    button,
    .platform-btn,
    .service-card,
    .category-option {
        -webkit-user-select: none;
        user-select: none;
    }
    
    /* Smooth scrolling */
    html {
        -webkit-overflow-scrolling: touch;
    }
    
    /* Fixed category dropdown on mobile */
    #categoryDropdownMenu {
        position: fixed;
        left: 0.75rem;
        right: 0.75rem;
        width: auto;
    }
}

/* Active states for better touch feedback */
button:active,
.platform-btn:active,
.service-card:active,
.category-option:active {
    opacity: 0.9;
}

/* Prevent text selection on buttons */
button,
.platform-btn {
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
}
</style>

<script>
/**
 * VinFlow Order Form
 * Features:
 * - Saves selected platform to localStorage for better UX
 * - Auto-selects user's last used platform on page load
 * - Dynamic category and service filtering
 */

let currentRate = 0;
let minOrder = 1;
let maxOrder = 100000;
let selectedPlatform = 'all';
let selectedService = null;
let couponDiscount = 0;
let userBalance = parseFloat('{{ user_balance|default:0 }}') || 0;

// Platform Selection with localStorage persistence
function selectPlatform(platform) {
    selectedPlatform = platform;
    
    // Save to localStorage for future visits
    try {
        localStorage.setItem('vinflow_selected_platform', platform);
        localStorage.setItem('vinflow_platform_timestamp', new Date().getTime());
    } catch (e) {
        console.log('localStorage not available');
    }
    
    // Update UI
    document.querySelectorAll('.platform-btn').forEach(btn => {
        btn.classList.remove('platform-active');
    });
    document.getElementById('platform-' + platform).classList.add('platform-active');
    
    // Filter categories based on platform
    filterCategories(platform);
    
    // Filter services
    filterServices();
}

// Load saved platform preference
function loadSavedPlatform() {
    try {
        const savedPlatform = localStorage.getItem('vinflow_selected_platform');
        const timestamp = localStorage.getItem('vinflow_platform_timestamp');
        
        if (savedPlatform && timestamp) {
            // Check if saved within last 30 days
            const daysSince = (new Date().getTime() - parseInt(timestamp)) / (1000 * 60 * 60 * 24);
            
            if (daysSince < 30) {
                // Check if the platform button exists
                const platformBtn = document.getElementById('platform-' + savedPlatform);
                if (platformBtn) {
                    // Add a subtle indicator for recent selection
                    addRecentIndicator(platformBtn);
                    return savedPlatform;
                }
            }
        }
    } catch (e) {
        console.log('localStorage not available');
    }
    return 'all'; // Default to 'all' if nothing saved or error
}

// Add visual indicator for recently used platform
function addRecentIndicator(button) {
    const badge = document.createElement('div');
    badge.className = 'recent-badge absolute -top-1 -right-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white text-xs px-2 py-0.5 rounded-full shadow-lg';
    badge.textContent = 'â­';
    badge.title = '{% trans "Recently used" %}';
    
    // Add position relative to button if not already
    button.style.position = 'relative';
    button.appendChild(badge);
}

// Toggle Category Dropdown
function toggleCategoryDropdown() {
    const menu = document.getElementById('categoryDropdownMenu');
    const arrow = document.getElementById('categoryDropdownArrow');
    
    if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
    } else {
        menu.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Select Category
function selectCategory(categoryId, element) {
    const categorySelect = document.getElementById('categorySelect');
    const displayDiv = document.getElementById('selectedCategoryDisplay');
    const menu = document.getElementById('categoryDropdownMenu');
    const arrow = document.getElementById('categoryDropdownArrow');
    
    // Update hidden select
    categorySelect.value = categoryId;
    
    // Remove selected class from all options
    document.querySelectorAll('.category-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // Add selected class to clicked element
    if (element) {
        element.classList.add('selected');
        // Update display from element's content
        const flexDiv = element.querySelector('div.flex');
        if (flexDiv) {
            displayDiv.innerHTML = flexDiv.innerHTML;
        }
    }
    
    // Close dropdown
    menu.classList.add('hidden');
    arrow.style.transform = 'rotate(0deg)';
    
    // Load services for the selected category
    if (categoryId) {
        loadServicesForCategory(categoryId);
    } else {
        // No category selected, show waiting message
        showWaitingMessage();
    }
}

// Load services for a specific category via AJAX
function loadServicesForCategory(categoryId) {
    const container = document.getElementById('servicesContainer');
    const waitingMessage = document.getElementById('waitingCategoryMessage');
    const loadingSpinner = document.getElementById('loadingServices');
    const serviceInfoText = document.getElementById('serviceInfoText');
    
    // Show loading state
    if (waitingMessage) waitingMessage.classList.add('hidden');
    if (loadingSpinner) loadingSpinner.classList.remove('hidden');
    if (serviceInfoText) serviceInfoText.textContent = '{% trans "Loading services..." %}';
    
    // Clear existing services
    const existingServices = container.querySelectorAll('.service-card');
    existingServices.forEach(card => card.remove());
    
    // Fetch services from API
    const searchTerm = document.getElementById('searchInput').value;
    const url = new URL('{% url "get_services_by_category" %}', window.location.origin);
    url.searchParams.append('category_id', categoryId);
    url.searchParams.append('platform', selectedPlatform);
    if (searchTerm) {
        url.searchParams.append('search', searchTerm);
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Hide loading spinner
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
            
            if (data.success && data.services && data.services.length > 0) {
                // Render services
                renderServices(data.services);
                
                // Update service info
                if (serviceInfoText) {
                    serviceInfoText.textContent = `{% trans "Found" %} ${data.count} {% trans "services. Click on a service to continue." %}`;
                }
            } else {
                // No services found
                showNoServicesMessage();
                if (serviceInfoText) {
                    serviceInfoText.textContent = '{% trans "No services available in this category" %}';
                }
            }
        })
        .catch(error => {
            console.error('Error loading services:', error);
            if (loadingSpinner) loadingSpinner.classList.add('hidden');
            showErrorMessage();
            if (serviceInfoText) {
                serviceInfoText.textContent = '{% trans "Error loading services. Please try again." %}';
            }
        });
}

// Render services dynamically
function renderServices(services) {
    const container = document.getElementById('servicesContainer');
    
    services.forEach(service => {
        const serviceCard = createServiceCard(service);
        container.appendChild(serviceCard);
    });
}

// Create a service card element
function createServiceCard(service) {
    const card = document.createElement('div');
    card.className = 'service-card service-item p-3 md:p-4 border-2 border-slate-700 rounded-lg active:scale-[0.98] cursor-pointer transition-all';
    card.dataset.serviceId = service.id;
    card.dataset.platform = service.platform_code || '';
    card.dataset.category = service.category_id || '';
    card.dataset.name = service.name.toLowerCase();
    card.dataset.rate = service.rate;
    card.dataset.min = service.min_order;
    card.dataset.max = service.max_order;
    card.dataset.drip = service.drip_feed_enabled;
    card.onclick = function() { selectService(this); };
    
    // Build social network icon HTML
    let socialNetworkHTML = '';
    if (service.social_network) {
        if (service.social_network.icon_image_url) {
            socialNetworkHTML = `<img src="${service.social_network.icon_image_url}" alt="${service.social_network.name}" class="w-4 h-4 object-contain flex-shrink-0">`;
        } else if (service.social_network.icon) {
            socialNetworkHTML = `<i class="${service.social_network.icon} text-sm flex-shrink-0" style="color: ${service.social_network.color}"></i>`;
        }
        socialNetworkHTML += `<span class="text-xs text-gray-400">${service.social_network.name}</span>`;
    }
    
    // Build badges HTML
    let badgesHTML = '';
    if (service.drip_feed_enabled) {
        badgesHTML += `
            <span class="text-xs px-2 py-1 bg-yellow-900/50 text-yellow-400 rounded inline-flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                </svg>
                SuperFast
            </span>
        `;
    }
    badgesHTML += `
        <span class="text-xs px-2 py-1 bg-green-900/50 text-green-400 rounded inline-flex items-center gap-1">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span class="hidden sm:inline">Ultrafast Completed</span>
            <span class="sm:hidden">Fast</span>
        </span>
    `;
    
    card.innerHTML = `
        <div class="flex flex-col sm:flex-row justify-between items-start gap-3">
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1 flex-wrap">
                    ${socialNetworkHTML}
                </div>
                <h3 class="font-semibold text-base md:text-lg leading-tight mb-1">
                    <span class="text-cyan-400">${service.external_service_id}</span>
                    - <span class="break-words">${service.name}</span>
                </h3>
                <div class="flex flex-wrap gap-1 mb-2">
                    ${badgesHTML}
                </div>
                <p class="text-xs md:text-sm text-gray-400 hidden sm:block">
                    ${service.description || ''}
                </p>
            </div>
            <div class="text-left sm:text-right w-full sm:w-auto sm:ml-4 flex-shrink-0 bg-slate-800/30 sm:bg-transparent rounded p-2 sm:p-0">
                <div class="text-cyan-400 font-bold text-base md:text-lg">$${service.rate.toFixed(4)}/1K</div>
                <div class="text-xs text-gray-400 flex gap-3 sm:block">
                    <span>Min: ${service.min_order.toLocaleString()}</span>
                    <span>Max: ${service.max_order.toLocaleString()}</span>
                </div>
            </div>
        </div>
    `;
    
    return card;
}

// Show waiting message
function showWaitingMessage() {
    const container = document.getElementById('servicesContainer');
    const waitingMessage = document.getElementById('waitingCategoryMessage');
    const loadingSpinner = document.getElementById('loadingServices');
    
    // Clear existing services
    const existingServices = container.querySelectorAll('.service-card');
    existingServices.forEach(card => card.remove());
    
    // Remove no services message if exists
    const noServicesMsg = container.querySelector('.no-services-message');
    if (noServicesMsg) noServicesMsg.remove();
    
    if (waitingMessage) waitingMessage.classList.remove('hidden');
    if (loadingSpinner) loadingSpinner.classList.add('hidden');
}

// Show no services message
function showNoServicesMessage() {
    const container = document.getElementById('servicesContainer');
    const noServicesMsg = container.querySelector('.no-services-message');
    
    if (!noServicesMsg) {
        const message = document.createElement('div');
        message.className = 'no-services-message text-center py-8 bg-slate-800/30 rounded-lg border-2 border-slate-700';
        message.innerHTML = `
            <svg class="w-12 h-12 mx-auto mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-gray-400">{% trans "No services found. Try adjusting your filters." %}</p>
        `;
        container.appendChild(message);
    }
}

// Show error message
function showErrorMessage() {
    const container = document.getElementById('servicesContainer');
    const message = document.createElement('div');
    message.className = 'no-services-message text-center py-8 bg-red-900/20 rounded-lg border-2 border-red-700';
    message.innerHTML = `
        <svg class="w-12 h-12 mx-auto mb-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-red-400">{% trans "Error loading services. Please try again." %}</p>
    `;
    container.appendChild(message);
}

// Filter Categories by Platform
function filterCategories(platform) {
    const categorySelect = document.getElementById('categorySelect');
    const options = categorySelect.querySelectorAll('option');
    const dropdownOptions = document.querySelectorAll('.category-option');
    let firstVisibleCategory = null;
    let firstVisibleElement = null;
    
    // Filter hidden select options
    options.forEach((option, index) => {
        const optionPlatform = option.dataset.platform;
        
        if (platform === 'all' || !optionPlatform) {
            option.style.display = '';
            if (!firstVisibleCategory) {
                firstVisibleCategory = option.value;
            }
        } else if (optionPlatform === platform) {
            option.style.display = '';
            if (!firstVisibleCategory) {
                firstVisibleCategory = option.value;
            }
        } else {
            option.style.display = 'none';
        }
    });
    
    // Filter custom dropdown options
    dropdownOptions.forEach((option) => {
        const optionPlatform = option.dataset.platform;
        
        if (platform === 'all' || !optionPlatform) {
            option.style.display = '';
            if (!firstVisibleElement) {
                firstVisibleElement = option;
            }
        } else if (optionPlatform === platform) {
            option.style.display = '';
            if (!firstVisibleElement) {
                firstVisibleElement = option;
            }
        } else {
            option.style.display = 'none';
        }
    });
    
    // Auto-select first matching category
    if (firstVisibleCategory && firstVisibleElement) {
        selectCategory(firstVisibleCategory, firstVisibleElement);
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const categoryDisplay = document.getElementById('categoryDisplay');
    const categoryMenu = document.getElementById('categoryDropdownMenu');
    const arrow = document.getElementById('categoryDropdownArrow');
    
    if (categoryDisplay && categoryMenu && !categoryDisplay.contains(event.target) && !categoryMenu.contains(event.target)) {
        categoryMenu.classList.add('hidden');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
    }
});

// Service Selection
function selectService(element) {
    // Remove previous selection
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection
    element.classList.add('selected');
    selectedService = element;
    
    // Set values with validation
    const serviceId = element.dataset.serviceId;
    if (!serviceId) {
        console.error('No service ID found');
        return;
    }
    
    const rate = parseFloat(element.dataset.rate);
    const min = parseInt(element.dataset.min);
    const max = parseInt(element.dataset.max);
    const dripEnabled = element.dataset.drip === 'true' || element.dataset.drip === true;
    
    // Set service ID in hidden field
    const serviceIdField = document.getElementById('service_id');
    if (serviceIdField) {
        serviceIdField.value = serviceId;
        console.log('Service selected:', serviceId);
    }
    
    currentRate = rate;
    minOrder = min;
    maxOrder = max;
    
    // Update quantity range
    document.getElementById('quantityRange').textContent = `{% trans "Min" %}: ${min.toLocaleString()} - {% trans "Max" %}: ${max.toLocaleString()}`;
    document.getElementById('quantityInput').min = min;
    document.getElementById('quantityInput').max = max;
    
    // Show/hide drip feed
    if (dripEnabled) {
        document.getElementById('dripFeedSection').classList.remove('hidden');
    } else {
        document.getElementById('dripFeedSection').classList.add('hidden');
    }
    
    // Update service info
    const serviceInfoText = document.getElementById('serviceInfoText');
    if (serviceInfoText) {
        serviceInfoText.textContent = element.querySelector('h3').textContent.trim();
    }
    document.getElementById('serviceError').classList.add('hidden');
    
    // Show step 3
    document.getElementById('step3').classList.remove('hidden');
    
    // Scroll to details
    setTimeout(() => {
        document.getElementById('linkInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
    
    // Update charge
    updateCharge();
}

// Filter Services - Now triggers reload from API
function filterServices() {
    const category = document.getElementById('categorySelect').value;
    
    // If no category selected, show waiting message
    if (!category) {
        showWaitingMessage();
        return;
    }
    
    // Reload services with current filters
    loadServicesForCategory(category);
}

// Quick Quantity Buttons
function setQuickQuantity(qty) {
    const input = document.getElementById('quantityInput');
    const qtyNum = Math.max(minOrder, Math.min(maxOrder, qty));
    input.value = qtyNum;
    updateCharge();
}

// Update Charge
function updateCharge() {
    const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
    const charge = (currentRate / 1000) * quantity;
    const finalCharge = Math.max(0, charge - couponDiscount);
    
    document.getElementById('totalCharge').textContent = '$' + finalCharge.toFixed(2);
    
    // Update summary
    updateOrderSummary();
    
    // Validate quantity
    validateQuantity(quantity);
    
    // Check balance
    checkBalance(finalCharge);
}

// Validate Quantity
function validateQuantity(quantity) {
    const errorEl = document.getElementById('quantityError');
    if (quantity < minOrder || quantity > maxOrder) {
        errorEl.textContent = `{% trans "Quantity must be between" %} ${minOrder.toLocaleString()} {% trans "and" %} ${maxOrder.toLocaleString()}`;
        errorEl.classList.remove('hidden');
        return false;
    } else {
        errorEl.classList.add('hidden');
        return true;
    }
}

// Check Balance
function checkBalance(charge) {
    const warningEl = document.getElementById('balanceWarning');
    const afterBalanceEl = document.getElementById('summaryAfterBalance');
    const submitBtn = document.getElementById('submitBtn');
    
    if (userBalance < charge) {
        const afterBalance = userBalance - charge;
        afterBalanceEl.textContent = '$' + afterBalance.toFixed(2);
        warningEl.style.display = 'flex';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg> {% trans "Insufficient Balance" %}';
    } else {
        warningEl.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> {% trans "Place Order" %}';
    }
}

// Validate Coupon
function validateCoupon() {
    const couponCode = document.getElementById('couponInput').value.trim().toUpperCase();
    const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
    const charge = (currentRate / 1000) * quantity;
    
    if (!couponCode) {
        document.getElementById('couponMessage').textContent = '';
        document.getElementById('couponSuccess').classList.add('hidden');
        document.getElementById('couponError').classList.add('hidden');
        couponDiscount = 0;
        updateCharge();
        return;
    }
    
    // Show loading
    document.getElementById('couponMessage').textContent = '{% trans "Validating coupon..." %}';
    document.getElementById('couponSuccess').classList.add('hidden');
    document.getElementById('couponError').classList.add('hidden');
    
    // AJAX request
    const formData = new FormData();
    formData.append('coupon_code', couponCode);
    formData.append('charge', charge);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "validate_coupon" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('couponMessage').textContent = '';
        if (data.status === 'success') {
            couponDiscount = data.discount;
            document.getElementById('couponSuccess').textContent = data.message;
            document.getElementById('couponSuccess').classList.remove('hidden');
            document.getElementById('couponError').classList.add('hidden');
        } else {
            couponDiscount = 0;
            document.getElementById('couponError').textContent = data.message;
            document.getElementById('couponError').classList.remove('hidden');
            document.getElementById('couponSuccess').classList.add('hidden');
        }
        updateCharge();
    })
    .catch(error => {
        document.getElementById('couponMessage').textContent = '';
        document.getElementById('couponError').textContent = '{% trans "Error validating coupon. Please try again." %}';
        document.getElementById('couponError').classList.remove('hidden');
        couponDiscount = 0;
        updateCharge();
    });
}

// Update Order Summary
function updateOrderSummary() {
    const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
    const link = document.getElementById('linkInput').value || '-';
    const charge = (currentRate / 1000) * quantity;
    const finalCharge = Math.max(0, charge - couponDiscount);
    
    if (selectedService) {
        document.getElementById('summaryService').textContent = selectedService.querySelector('h3').textContent.trim();
    }
    document.getElementById('summaryLink').textContent = link.length > 50 ? link.substring(0, 50) + '...' : link;
    document.getElementById('summaryQuantity').textContent = quantity.toLocaleString();
    document.getElementById('summaryRate').textContent = '$' + currentRate.toFixed(4) + '/1K';
    document.getElementById('summarySubtotal').textContent = '$' + charge.toFixed(2);
    
    if (couponDiscount > 0) {
        document.getElementById('summaryDiscount').textContent = '-$' + couponDiscount.toFixed(2);
        document.getElementById('summaryDiscountRow').style.display = 'flex';
    } else {
        document.getElementById('summaryDiscountRow').style.display = 'none';
    }
    
    // Show step 4 when all required fields are filled
    if (document.getElementById('service_id').value && 
        document.getElementById('linkInput').value && 
        quantity >= minOrder && quantity <= maxOrder) {
        document.getElementById('step4').classList.remove('hidden');
    }
}

// Form Validation
document.getElementById('orderForm').addEventListener('submit', function(e) {
    // Validate service selection
    const serviceId = document.getElementById('service_id').value;
    if (!serviceId || serviceId.trim() === '') {
        e.preventDefault();
        document.getElementById('serviceError').textContent = '{% trans "Please select a service to continue" %}';
        document.getElementById('serviceError').classList.remove('hidden');
        document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
        return false;
    }
    
    // Validate link
    const link = document.getElementById('linkInput').value;
    if (!link || link.trim() === '') {
        e.preventDefault();
        document.getElementById('linkError').textContent = '{% trans "Please enter a valid URL" %}';
        document.getElementById('linkError').classList.remove('hidden');
        document.getElementById('linkInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    // Validate quantity
    const quantityInput = document.getElementById('quantityInput').value;
    if (!quantityInput || quantityInput.trim() === '') {
        e.preventDefault();
        document.getElementById('quantityError').textContent = '{% trans "Please enter a quantity" %}';
        document.getElementById('quantityError').classList.remove('hidden');
        document.getElementById('quantityInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    const quantity = parseInt(quantityInput);
    if (isNaN(quantity) || quantity <= 0) {
        e.preventDefault();
        document.getElementById('quantityError').textContent = '{% trans "Please enter a valid quantity" %}';
        document.getElementById('quantityError').classList.remove('hidden');
        document.getElementById('quantityInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    if (!validateQuantity(quantity)) {
        e.preventDefault();
        document.getElementById('quantityInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    // Validate balance
    const finalCharge = (currentRate / 1000) * quantity - couponDiscount;
    if (userBalance < finalCharge) {
        e.preventDefault();
        alert('{% trans "Insufficient balance. Please top up your account." %}');
        return false;
    }
    
    // If drip feed is enabled, validate drip feed values
    const dripFeed = document.getElementById('drip_feed').checked;
    if (dripFeed) {
        const dripQuantity = document.getElementById('drip_feed_quantity').value;
        const dripDays = document.getElementById('drip_feed_days').value;
        
        if (!dripQuantity || !dripDays || parseInt(dripQuantity) <= 0 || parseInt(dripDays) <= 0) {
            e.preventDefault();
            alert('{% trans "Please enter valid drip feed values" %}');
            return false;
        }
    }
});

// Search Input Event - Debounced for better performance
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        filterServices();
    }, 500); // Wait 500ms after user stops typing
});

// Quantity Input Event
document.getElementById('quantityInput').addEventListener('input', function() {
    updateCharge();
    updateOrderSummary();
});

// Link Input Event
document.getElementById('linkInput').addEventListener('input', function() {
    document.getElementById('linkError').classList.add('hidden');
    updateOrderSummary();
});

// Drip Feed Toggle
document.getElementById('drip_feed').addEventListener('change', function() {
    document.getElementById('dripFeedOptions').classList.toggle('hidden', !this.checked);
});

// Initialize - Load saved platform and auto-select first category
document.addEventListener('DOMContentLoaded', function() {
    // Show waiting message initially
    const waitingMessage = document.getElementById('waitingCategoryMessage');
    if (waitingMessage) {
        waitingMessage.classList.remove('hidden');
    }
    
    // Load and select saved platform preference
    const savedPlatform = loadSavedPlatform();
    if (savedPlatform && savedPlatform !== 'all') {
        selectPlatform(savedPlatform);
    } else {
        // If 'all' or no saved platform, still need to select first category
        const firstCategoryOption = document.querySelector('.category-option.category-first');
        if (firstCategoryOption) {
            const categoryId = firstCategoryOption.dataset.categoryId;
            selectCategory(categoryId, firstCategoryOption);
        }
    }
});
</script>
{% endblock %}
