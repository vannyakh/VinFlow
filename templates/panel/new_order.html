{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "New Order" %} - VinFlow{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">{% trans "Create New Order" %}</h1>
        <a href="{% url 'orders' %}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
            {% trans "View Orders" %}
        </a>
    </div>
    
    <!-- Promotions Banner -->
    {% include 'panel/partials/promotion_banner.html' with location='checkout' %}
    
    <!-- Platform Selection -->
    <div class="card-glass rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4">üéØ {% trans "Select Platform" %}</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button onclick="selectPlatform('all')" id="platform-all" class="platform-btn platform-active p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <span class="text-2xl">üìã</span>
                <span class="font-semibold">{% trans "Everything" %}</span>
            </button>
            <button onclick="selectPlatform('tt')" id="platform-tt" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <span class="text-2xl">üéµ</span>
                <span class="font-semibold">TikTok</span>
            </button>
            <button onclick="selectPlatform('yt')" id="platform-yt" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <span class="text-2xl">‚ñ∂Ô∏è</span>
                <span class="font-semibold">YouTube</span>
            </button>
            <button onclick="selectPlatform('tg')" id="platform-tg" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <span class="text-2xl">‚úàÔ∏è</span>
                <span class="font-semibold">Telegram</span>
            </button>
            <button onclick="selectPlatform('ig')" id="platform-ig" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <span class="text-2xl">üì∏</span>
                <span class="font-semibold">Instagram</span>
            </button>
            <button onclick="selectPlatform('fb')" id="platform-fb" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <span class="text-2xl">üë•</span>
                <span class="font-semibold">Facebook</span>
            </button>
            <button onclick="selectPlatform('tw')" id="platform-tw" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <span class="text-2xl">üê¶</span>
                <span class="font-semibold">Twitter/X</span>
            </button>
            <button onclick="selectPlatform('sp')" id="platform-sp" class="platform-btn p-4 rounded-lg border-2 border-slate-700 hover:border-purple-500 transition flex flex-col items-center gap-2">
                <span class="text-2xl">üéß</span>
                <span class="font-semibold">Spotify</span>
            </button>
        </div>
    </div>
    
    <!-- Order Form -->
    <div class="card-glass rounded-xl p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">üìù {% trans "Order Details" %}</h2>
            <button onclick="window.open('https://youtu.be/example', '_blank')" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm flex items-center gap-2">
                <span>‚≠ê</span>
                {% trans "Video Tutorial" %}
            </button>
        </div>
        
        <form method="post" action="{% url 'create_order' %}" id="orderForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- Search Services -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    <span class="text-xl">üîç</span> {% trans "Search" %}
                </label>
                <input type="text" id="searchInput" placeholder="{% trans 'Search services...' %}" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none">
            </div>
            
            <!-- Category Selection -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    <span class="text-xl">üì¶</span> {% trans "Category" %}
                </label>
                <select id="categorySelect" onchange="filterServices()" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none">
                    <option value="">{% trans "All Categories" %}</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">
                            {% if is_khmer %}{{ category.name_km|default:category.name }}{% else %}{{ category.name }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Service Selection -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    <span class="text-xl">üõ†Ô∏è</span> {% trans "Service" %} *
                </label>
                <input type="hidden" name="service_id" id="service_id" required>
                <div id="servicesContainer" class="space-y-2 max-h-96 overflow-y-auto">
                    {% for service in services %}
                        <div class="service-card p-4 border-2 border-slate-700 rounded-lg hover:border-purple-500 cursor-pointer transition"
                             data-service-id="{{ service.id }}"
                             data-platform="{{ service.service_type }}"
                             data-category="{{ service.category.id|default:'' }}"
                             data-name="{{ service.name|lower }}"
                             data-rate="{{ service.rate }}"
                             data-min="{{ service.min_order }}"
                             data-max="{{ service.max_order }}"
                             data-drip="{{ service.drip_feed_enabled|yesno:'true,false' }}"
                             onclick="selectService(this)">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg">
                                        <span class="text-cyan-400">{{ service.external_service_id }}</span>
                                        - {% if is_khmer %}{{ service.name_km|default:service.name }}{% else %}{{ service.name }}{% endif %}
                                        {% if service.drip_feed_enabled %}
                                            <span class="text-xs px-2 py-1 bg-yellow-900/50 text-yellow-400 rounded ml-2">‚ö° SuperFast</span>
                                        {% endif %}
                                        <span class="text-xs px-2 py-1 bg-green-900/50 text-green-400 rounded ml-2">‚ú® Ultrafast Completed</span>
                                    </h3>
                                    <p class="text-sm text-gray-400 mt-1">
                                        {% if is_khmer %}{{ service.description_km|default:service.description|truncatewords:20 }}{% else %}{{ service.description|truncatewords:20 }}{% endif %}
                                    </p>
                                </div>
                                <div class="text-right ml-4">
                                    <div class="text-cyan-400 font-bold">${{ service.rate|floatformat:4 }}/1K</div>
                                    <div class="text-xs text-gray-400">Min: {{ service.min_order }}</div>
                                    <div class="text-xs text-gray-400">Max: {{ service.max_order }}</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-400 mt-2" id="serviceInfo">{% trans "Please select a service" %}</p>
            </div>
            
            <!-- Link Input -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    <span class="text-xl">üîó</span> {% trans "Link" %} *
                </label>
                <input type="url" name="link" id="linkInput" required placeholder="https://..." class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none">
            </div>
            
            <!-- Quantity Input -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    <span class="text-xl">üî¢</span> {% trans "Quantity" %} *
                </label>
                <input type="number" name="quantity" id="quantityInput" required min="1" placeholder="100" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none" oninput="updateCharge()">
                <p class="text-xs text-gray-400 mt-1" id="quantityRange">{% trans "Min: 5 - Max: 20,000,000" %}</p>
            </div>
            
            <!-- Average Time -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    <span class="text-xl">‚è±Ô∏è</span> {% trans "Average time" %} ‚ìò
                </label>
                <div class="bg-slate-700/30 border border-slate-600 rounded-lg px-4 py-3 text-gray-400">
                    <span id="avgTime">1 {% trans "hour" %} 7 {% trans "minutes" %}</span>
                </div>
            </div>
            
            <!-- Drip Feed Options (Hidden by default) -->
            <div id="dripFeedSection" class="hidden space-y-4">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" name="drip_feed" id="drip_feed" class="rounded">
                    <label for="drip_feed" class="text-sm font-medium">{% trans "Enable Drip-Feed (Spread delivery over multiple days)" %}</label>
                </div>
                <div id="dripFeedOptions" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm mb-2">{% trans "Quantity per day" %}</label>
                        <input type="number" name="drip_feed_quantity" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm mb-2">{% trans "Number of days" %}</label>
                        <input type="number" name="drip_feed_days" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2">
                    </div>
                </div>
            </div>
            
            <!-- Coupon Code -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    <span class="text-xl">üéüÔ∏è</span> {% trans "Coupon Code (Optional)" %}
                </label>
                <input type="text" name="coupon_code" id="couponInput" placeholder="VINOPENING" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none">
            </div>
            
            <!-- Charge Display -->
            <div class="border-t border-slate-700 pt-6">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-lg text-gray-400">üí∞ {% trans "Charge" %}:</span>
                    <span class="text-3xl font-bold text-cyan-400" id="totalCharge">$0.00</span>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-4 rounded-lg text-lg transition transform hover:scale-105">
                    <span class="text-xl">üöÄ</span> {% trans "Submit" %}
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.platform-active {
    border-color: #a855f7 !important;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
}

.service-card.selected {
    border-color: #a855f7 !important;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
}

.service-card.hidden {
    display: none;
}
</style>

<script>
let currentRate = 0;
let minOrder = 1;
let maxOrder = 100000;
let selectedPlatform = 'all';

// Platform Selection
function selectPlatform(platform) {
    selectedPlatform = platform;
    
    // Update UI
    document.querySelectorAll('.platform-btn').forEach(btn => {
        btn.classList.remove('platform-active');
    });
    document.getElementById('platform-' + platform).classList.add('platform-active');
    
    // Filter services
    filterServices();
}

// Service Selection
function selectService(element) {
    // Remove previous selection
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection
    element.classList.add('selected');
    
    // Set values
    const serviceId = element.dataset.serviceId;
    const rate = parseFloat(element.dataset.rate);
    const min = parseInt(element.dataset.min);
    const max = parseInt(element.dataset.max);
    const dripEnabled = element.dataset.drip === 'true';
    
    document.getElementById('service_id').value = serviceId;
    currentRate = rate;
    minOrder = min;
    maxOrder = max;
    
    // Update quantity range
    document.getElementById('quantityRange').textContent = `{% trans "Min" %}: ${min} - {% trans "Max" %}: ${max.toLocaleString()}`;
    document.getElementById('quantityInput').min = min;
    document.getElementById('quantityInput').max = max;
    
    // Show/hide drip feed
    if (dripEnabled) {
        document.getElementById('dripFeedSection').classList.remove('hidden');
    } else {
        document.getElementById('dripFeedSection').classList.add('hidden');
    }
    
    // Update service info
    document.getElementById('serviceInfo').textContent = element.querySelector('h3').textContent.trim();
    
    // Update charge
    updateCharge();
    
    // Scroll to link input
    document.getElementById('linkInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Filter Services
function filterServices() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categorySelect').value;
    
    document.querySelectorAll('.service-card').forEach(card => {
        const cardPlatform = card.dataset.platform;
        const cardCategory = card.dataset.category;
        const cardName = card.dataset.name;
        
        let show = true;
        
        // Platform filter
        if (selectedPlatform !== 'all' && cardPlatform !== selectedPlatform) {
            show = false;
        }
        
        // Category filter
        if (category && cardCategory !== category) {
            show = false;
        }
        
        // Search filter
        if (searchTerm && !cardName.includes(searchTerm)) {
            show = false;
        }
        
        if (show) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
}

// Update Charge
function updateCharge() {
    const quantity = parseInt(document.getElementById('quantityInput').value) || 0;
    const charge = (currentRate / 1000) * quantity;
    document.getElementById('totalCharge').textContent = '$' + charge.toFixed(2);
}

// Search Input Event
document.getElementById('searchInput').addEventListener('input', filterServices);

// Drip Feed Toggle
document.getElementById('drip_feed').addEventListener('change', function() {
    document.getElementById('dripFeedOptions').classList.toggle('hidden', !this.checked);
});

// Form Validation
document.getElementById('orderForm').addEventListener('submit', function(e) {
    const serviceId = document.getElementById('service_id').value;
    if (!serviceId) {
        e.preventDefault();
        alert('{% trans "Please select a service" %}');
        return false;
    }
    
    const quantity = parseInt(document.getElementById('quantityInput').value);
    if (quantity < minOrder || quantity > maxOrder) {
        e.preventDefault();
        alert(`{% trans "Quantity must be between" %} ${minOrder} {% trans "and" %} ${maxOrder}`);
        return false;
    }
});

// Initialize
filterServices();
</script>
{% endblock %}

