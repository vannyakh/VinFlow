{% extends 'base.html' %}

{% block title %}{% if is_khmer %}ការកម្មង់{% else %}Orders{% endif %} - VinFlow{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center flex-wrap gap-4">
        <h1 class="text-3xl font-bold">{% if is_khmer %}ការកម្មង់{% else %}Orders{% endif %}</h1>
        <div class="flex gap-2">
            <button onclick="document.getElementById('massUploadModal').classList.remove('hidden')" class="btn-primary text-sm">
                {% if is_khmer %}កម្មង់ច្រើន (CSV){% else %}Mass Order (CSV){% endif %}
            </button>
            <a href="{% url 'services' %}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                {% if is_khmer %}កម្មង់ថ្មី{% else %}New Order{% endif %}
            </a>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="card-glass rounded-xl p-4">
        <div class="flex gap-2 flex-wrap">
            <a href="{% url 'orders' %}" class="px-4 py-2 rounded-lg {% if not status_filter %}bg-purple-600{% else %}bg-slate-700 hover:bg-slate-600{% endif %} text-sm">
                {% if is_khmer %}ទាំងអស់{% else %}All{% endif %}
            </a>
            <a href="?status=Pending" class="px-4 py-2 rounded-lg {% if status_filter == 'Pending' %}bg-purple-600{% else %}bg-slate-700 hover:bg-slate-600{% endif %} text-sm">
                {% if is_khmer %}រង់ចាំ{% else %}Pending{% endif %}
            </a>
            <a href="?status=Processing" class="px-4 py-2 rounded-lg {% if status_filter == 'Processing' %}bg-purple-600{% else %}bg-slate-700 hover:bg-slate-600{% endif %} text-sm">
                {% if is_khmer %}កំពុងដំណើរការ{% else %}Processing{% endif %}
            </a>
            <a href="?status=Completed" class="px-4 py-2 rounded-lg {% if status_filter == 'Completed' %}bg-purple-600{% else %}bg-slate-700 hover:bg-slate-600{% endif %} text-sm">
                {% if is_khmer %}បានបញ្ចប់{% else %}Completed{% endif %}
            </a>
        </div>
    </div>
    
    <!-- Orders List -->
    <div class="card-glass rounded-xl p-6">
        {% if orders %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-slate-700">
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}លេខកម្មង់{% else %}Order ID{% endif %}</th>
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}សេវាកម្ម{% else %}Service{% endif %}</th>
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}តំណភ្ជាប់{% else %}Link{% endif %}</th>
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}បរិមាណ{% else %}Quantity{% endif %}</th>
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}ស្ថានភាព{% else %}Status{% endif %}</th>
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}ចាប់ផ្តើម{% else %}Start{% endif %}</th>
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}នៅសល់{% else %}Remains{% endif %}</th>
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}កាលបរិច្ឆេទ{% else %}Date{% endif %}</th>
                            <th class="text-left py-3 px-4 text-gray-400">{% if is_khmer %}សកម្មភាព{% else %}Action{% endif %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr class="border-b border-slate-800 hover:bg-slate-800/50" id="order-{{ order.id }}">
                            <td class="py-3 px-4">
                                <a href="{% url 'order_detail' order.id %}" class="text-purple-400 hover:text-purple-300">
                                    {{ order.order_id }}
                                </a>
                            </td>
                            <td class="py-3 px-4">{{ order.service.name }}</td>
                            <td class="py-3 px-4">
                                <a href="{{ order.link }}" target="_blank" class="text-cyan-400 hover:text-cyan-300 text-sm truncate max-w-xs block">
                                    {{ order.link|truncatechars:30 }}
                                </a>
                            </td>
                            <td class="py-3 px-4">{{ order.quantity }}</td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded text-xs
                                    {% if order.status == 'Completed' %}bg-green-900/50 text-green-400
                                    {% elif order.status == 'Processing' or order.status == 'In Progress' %}bg-yellow-900/50 text-yellow-400
                                    {% elif order.status == 'Pending' %}bg-blue-900/50 text-blue-400
                                    {% else %}bg-red-900/50 text-red-400{% endif %}" 
                                    id="status-{{ order.id }}">
                                    {{ order.status }}
                                </span>
                            </td>
                            <td class="py-3 px-4" id="start-{{ order.id }}">{{ order.start_count }}</td>
                            <td class="py-3 px-4" id="remains-{{ order.id }}">{{ order.remains }}</td>
                            <td class="py-3 px-4 text-sm text-gray-400">{{ order.created_at|date:"M d, Y" }}</td>
                            <td class="py-3 px-4">
                                {% if order.status in 'Pending,Processing' %}
                                    <div hx-get="{% url 'order_status' order.id %}" 
                                         hx-trigger="every 60s" 
                                         hx-target="#order-{{ order.id }}" 
                                         hx-swap="outerHTML"
                                         class="htmx-indicator">
                                        <div class="spinner"></div>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-400 text-center py-8">{% if is_khmer %}មិនមានការកម្មង់{% else %}No orders found{% endif %}</p>
        {% endif %}
    </div>
</div>

<!-- Mass Upload Modal -->
<div id="massUploadModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50" onclick="this.classList.add('hidden')">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <h2 class="text-2xl font-bold mb-4">{% if is_khmer %}កម្មង់ច្រើន (CSV){% else %}Mass Order Upload{% endif %}</h2>
        <p class="text-sm text-gray-400 mb-4">
            {% if is_khmer %}ផ្ទុក CSV file ដែលមាន columns: service_id, link, quantity{% else %}Upload CSV file with columns: service_id, link, quantity{% endif %}
        </p>
        <form method="post" action="{% url 'mass_order_upload' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name="csv_file" accept=".csv" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 mb-4">
            <div class="flex gap-2">
                <button type="submit" class="flex-1 btn-primary">{% if is_khmer %}ផ្ទុក{% else %}Upload{% endif %}</button>
                <button type="button" onclick="document.getElementById('massUploadModal').classList.add('hidden')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">
                    {% if is_khmer %}បោះបង់{% else %}Cancel{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

