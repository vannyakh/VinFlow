{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "KHQR Payment" %} - VinFlow{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-4 md:space-y-6 px-4 md:px-0 py-4 md:py-0">
    <h1 class="text-2xl md:text-3xl font-bold text-center md:text-left">{% trans "KHQR Bakong Payment" %}</h1>
    
    <!-- Payment Information Card -->
    <div class="card-glass rounded-xl p-4 md:p-6">
        <div class="text-center space-y-3 md:space-y-4">
            <div class="inline-flex items-center justify-center w-14 h-14 md:w-16 md:h-16 bg-red-500/20 rounded-full">
                <svg class="w-7 h-7 md:w-8 md:h-8 text-red-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8zM5 5v4h4V5H5zm10 0v4h4V5h-4zM5 15v4h4v-4H5zm10 0v4h4v-4h-4z"/>
                </svg>
            </div>
            
            <div>
                <p class="text-gray-400 text-xs md:text-sm mb-1">{% trans "Amount to Pay" %}</p>
                <p class="text-3xl md:text-4xl font-bold text-white">${{ payment.amount|floatformat:2 }}</p>
            </div>
            
            <div>
                <p class="text-gray-400 text-xs md:text-sm mb-1">{% trans "Transaction ID" %}</p>
                <p class="text-base md:text-lg font-mono text-purple-400 break-all px-2">{{ payment.transaction_id }}</p>
            </div>
        </div>
    </div>
    
    <!-- QR Code Card -->
    <div class="card-glass rounded-xl p-4 md:p-6">
        <h2 class="text-lg md:text-xl font-bold mb-3 md:mb-4 text-center">{% trans "Scan QR Code to Pay" %}</h2>
        
        <!-- Expiration Timer -->
        <div id="qr-expiration-timer" class="mb-4 text-center">
            <div class="inline-flex items-center space-x-2 px-3 md:px-4 py-2 rounded-lg bg-yellow-500/20 border border-yellow-500/30">
                <svg class="w-4 h-4 md:w-5 md:h-5 text-yellow-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-yellow-400 font-semibold text-xs md:text-sm">
                    <span class="hidden sm:inline">{% trans "QR Code expires in:" %}</span>
                    <span class="sm:hidden">{% trans "Expires:" %}</span>
                    <span id="countdown-timer" class="font-mono ml-1">03:00</span>
                </span>
            </div>
        </div>
        
        
        <div class="flex justify-center mb-4 md:mb-6">
            {% if khqr_data.qr_string %}
                <div id="qr-container" class="bg-white p-3 md:p-4 rounded-xl shadow-lg">
                    <!-- Generate QR Code from qr_string using a QR code library or image -->
                    <div id="qrcode" class="w-56 h-56 md:w-64 md:h-64 flex items-center justify-center"></div>
                </div>
            {% else %}
                <div class="bg-white p-3 md:p-4 rounded-xl shadow-lg">
                    <div class="w-56 h-56 md:w-64 md:h-64 flex items-center justify-center text-gray-800 text-sm">
                        {% trans "QR Code will appear here" %}
                    </div>
                </div>
            {% endif %}
        </div>
        
        <!-- Deeplink Button for Mobile -->
        {% if khqr_data.deeplink %}
        <div class="flex justify-center mb-4">
            <a href="{{ khqr_data.deeplink }}" 
               class="px-5 md:px-6 py-3 md:py-3 bg-red-600 hover:bg-red-700 active:bg-red-800 rounded-lg text-white font-semibold transition inline-flex items-center space-x-2 text-sm md:text-base touch-manipulation shadow-lg">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>{% trans "Pay with Bakong App" %}</span>
            </a>
        </div>
        {% endif %}
        
        <!-- Instructions -->
        <div class="space-y-2 md:space-y-3 px-2 md:px-0">
            <p class="text-xs md:text-sm text-gray-300 text-center font-semibold">{% trans "How to Pay:" %}</p>
            <ol class="list-decimal list-inside space-y-1.5 md:space-y-2 text-xs md:text-sm text-gray-400">
                <li>{% trans "Open your Bakong or any KHQR-enabled banking app" %}</li>
                <li>{% trans "Scan the QR code above" %}</li>
                <li>{% trans "Confirm the payment amount" %}</li>
                <li>{% trans "Complete the payment in your banking app" %}</li>
            </ol>
        </div>
        
        <!-- Payment Status Check -->
        <div class="mt-4 md:mt-6 pt-4 md:pt-6 border-t border-slate-700">
            <div id="payment-status" class="text-center">
                <div class="inline-flex items-center space-x-2 text-yellow-400">
                    <svg class="animate-spin h-4 w-4 md:h-5 md:w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-xs md:text-sm">{% trans "Waiting for payment confirmation..." %}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Card -->
    <div class="card-glass rounded-xl p-4 md:p-6 bg-blue-900/20 border border-blue-500/30">
        <div class="flex items-start space-x-2 md:space-x-3">
            <svg class="w-5 h-5 text-blue-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <h3 class="font-semibold text-blue-400 mb-1 text-sm md:text-base">{% trans "Important Information" %}</h3>
                <ul class="text-xs md:text-sm text-gray-300 space-y-1 leading-relaxed">
                    <li>• {% trans "Payment verification may take a few minutes" %}</li>
                    <li>• {% trans "Do not close this page until payment is confirmed" %}</li>
                    <li>• {% trans "Funds will be added to your account automatically upon successful payment" %}</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-3 md:gap-4 pb-4">
        <button 
            onclick="checkPaymentStatus()" 
            class="flex-1 px-4 py-3 md:py-2 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 rounded-lg text-center text-sm md:text-base font-medium transition touch-manipulation"
        >
            {% trans "Check Payment Status" %}
        </button>
        <a href="{% url 'transaction_logs' %}" class="flex-1 px-4 py-3 md:py-2 bg-slate-700 hover:bg-slate-600 active:bg-slate-500 rounded-lg text-center text-sm md:text-base font-medium transition touch-manipulation">
            {% trans "View Transactions" %}
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
// QR Code expiration and countdown
let qrExpirationTime = null;
let countdownInterval = null;
let qrCodeInstance = null;

// Initialize QR Code expiration timer
{% if khqr_data.expires_at %}
    qrExpirationTime = new Date('{{ khqr_data.expires_at }}').getTime();
{% elif khqr_data.expires_in_seconds %}
    // Fallback: use expires_in_seconds if expires_at is not available
    const expiresInSeconds = {{ khqr_data.expires_in_seconds|default:180 }};
    qrExpirationTime = Date.now() + (expiresInSeconds * 1000);
{% else %}
    // Default: 3 minutes from now
    qrExpirationTime = Date.now() + (3 * 60 * 1000);
{% endif %}

// Generate QR Code from qr_string
{% if khqr_data.qr_string %}
document.addEventListener('DOMContentLoaded', function() {
    // Determine QR code size based on screen width
    const isMobile = window.innerWidth < 768;
    const qrSize = isMobile ? 224 : 256; // 224px for mobile (56*4), 256px for desktop (64*4)
    
    qrCodeInstance = new QRCode(document.getElementById("qrcode"), {
        text: "{{ khqr_data.qr_string|escapejs }}",
        width: qrSize,
        height: qrSize,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });
    
    // Start countdown timer
    startCountdown();
});
{% endif %}

// Countdown timer function
function startCountdown() {
    if (!qrExpirationTime) return;
    
    countdownInterval = setInterval(function() {
        const now = Date.now();
        const timeLeft = qrExpirationTime - now;
        
        if (timeLeft <= 0) {
            // QR Code expired
            clearInterval(countdownInterval);
            handleQRExpiration();
            return;
        }
        
        // Update countdown display
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        const displayTime = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        
        const countdownElement = document.getElementById('countdown-timer');
        if (countdownElement) {
            countdownElement.textContent = displayTime;
            
            // Change color when less than 1 minute remaining
            if (timeLeft < 60000) {
                countdownElement.parentElement.parentElement.classList.remove('bg-yellow-500/20', 'border-yellow-500/30');
                countdownElement.parentElement.parentElement.classList.add('bg-red-500/20', 'border-red-500/30');
                countdownElement.parentElement.querySelector('svg').classList.remove('text-yellow-400');
                countdownElement.parentElement.querySelector('svg').classList.add('text-red-400');
                countdownElement.parentElement.querySelector('span').classList.remove('text-yellow-400');
                countdownElement.parentElement.querySelector('span').classList.add('text-red-400');
            }
        }
    }, 1000);
}

// Handle QR expiration
function handleQRExpiration() {
    // Stop payment status checking
    if (checkInterval) {
        clearInterval(checkInterval);
    }
    
    // Stop countdown timer
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    // Show brief message before redirecting
    const statusDiv = document.getElementById('payment-status');
    if (statusDiv) {
        statusDiv.innerHTML = `
            <div class="inline-flex items-center space-x-2 text-red-400">
                <svg class="h-5 w-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>{% trans "QR Code expired. Redirecting..." %}</span>
            </div>
        `;
    }
    
    // Redirect to transaction logs after 2 seconds
    setTimeout(() => {
        window.location.href = '{% url "transaction_logs" %}';
    }, 2000);
}

let checkInterval;

// Auto-check payment status every 5 seconds
function startAutoCheck() {
    checkInterval = setInterval(checkPaymentStatus, 5000);
}

function checkPaymentStatus() {
    fetch('{% url "check_payment_status" payment.id %}')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('payment-status');
            
            if (data.status === 'completed') {
                clearInterval(checkInterval);
                statusDiv.innerHTML = `
                    <div class="inline-flex items-center space-x-2 text-green-400">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span>{% trans "Payment Successful!" %}</span>
                    </div>
                `;
                
                // Redirect to dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = '{% url "dashboard" %}';
                }, 2000);
            } else if (data.status === 'expired') {
                clearInterval(checkInterval);
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                statusDiv.innerHTML = `
                    <div class="inline-flex items-center space-x-2 text-red-400">
                        <svg class="h-5 w-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>{% trans "QR Code expired. Redirecting..." %}</span>
                    </div>
                `;
                // Redirect to transaction logs
                setTimeout(() => {
                    window.location.href = '{% url "transaction_logs" %}';
                }, 2000);
            } else if (data.status === 'failed' || data.status === 'canceled') {
                clearInterval(checkInterval);
                statusDiv.innerHTML = `
                    <div class="inline-flex items-center space-x-2 text-red-400">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <span>{% trans "Payment Failed" %}</span>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
}

// Start auto-checking when page loads
window.addEventListener('load', startAutoCheck);

// Stop checking when page is closed
window.addEventListener('beforeunload', () => {
    clearInterval(checkInterval);
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
});
</script>
{% endblock %}

