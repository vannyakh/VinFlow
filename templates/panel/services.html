{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Services" %} - VinFlow{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">{% trans "Services" %}</h1>
        <a href="{% url 'free_trial' %}" class="btn-primary">
            {% trans "Free 100 Likes" %}
        </a>
    </div>
    
    <!-- Service Categories -->
    {% for category, services in services_by_category.items %}
        <div class="card-glass rounded-xl p-6">
            <h2 class="text-2xl font-bold mb-4">
                {% if is_khmer %}{{ category.name_km|default:category.name }}{% else %}{{ category.name }}{% endif %}
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for service in services %}
                    <div class="border border-slate-700 rounded-lg p-4 hover:border-purple-500 transition">
                        <h3 class="font-semibold text-lg mb-2">
                            {% if is_khmer %}{{ service.name_km|default:service.name }}{% else %}{{ service.name }}{% endif %}
                        </h3>
                        <p class="text-sm text-gray-400 mb-3">
                            {% if is_khmer %}{{ service.description_km|default:service.description|truncatewords:15 }}{% else %}{{ service.description|truncatewords:15 }}{% endif %}
                        </p>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-cyan-400 font-bold">${{ service.rate|floatformat:4 }}/1K</span>
                            <span class="text-sm text-gray-400">{{ service.min_order }}-{{ service.max_order }}</span>
                        </div>
                        
                        <button onclick="openOrderModal({{ service.id }}, '{{ service.name }}', {{ service.rate }}, {{ service.min_order }}, {{ service.max_order }}, {{ service.drip_feed_enabled|yesno:"true,false" }}, {{ service.refill_enabled|yesno:"true,false" }})" 
                                class="w-full btn-primary text-sm">
                            {% trans "Order Now" %}
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
</div>

<!-- Order Modal -->
<div id="orderModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50" onclick="closeOrderModal()">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">{% trans "Create Order" %}</h2>
            <button onclick="closeOrderModal()" class="text-gray-400 hover:text-white">âœ•</button>
        </div>
        
        <form method="post" action="{% url 'create_order' %}" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="service_id" id="modal_service_id">
            
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Service" %}</label>
                <input type="text" id="modal_service_name" readonly class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Link" %} *</label>
                <input type="url" name="link" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Quantity" %} *</label>
                <input type="number" name="quantity" id="modal_quantity" required min="1" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none">
                <p class="text-xs text-gray-400 mt-1">{% trans "Range" %}: <span id="modal_range"></span></p>
            </div>
            
            <div id="dripFeedSection" class="hidden">
                <div class="flex items-center space-x-2 mb-2">
                    <input type="checkbox" name="drip_feed" id="drip_feed" class="rounded">
                    <label for="drip_feed" class="text-sm">{% trans "Drip-Feed (Spread over days)" %}</label>
                </div>
                <div id="dripFeedOptions" class="hidden space-y-2">
                    <input type="number" name="drip_feed_quantity" placeholder="{% trans 'Quantity per day' %}" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <input type="number" name="drip_feed_days" placeholder="{% trans 'Number of days' %}" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Coupon Code (Optional)" %}</label>
                <input type="text" name="coupon_code" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none" placeholder="VINOPENING">
            </div>
            
            <div class="pt-4 border-t border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-400">{% trans "Total Charge" %}:</span>
                    <span class="text-2xl font-bold text-cyan-400" id="total_charge">$0.00</span>
                </div>
                <button type="submit" class="w-full btn-primary">
                    {% trans "Create Order" %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentRate = 0;
let minOrder = 1;
let maxOrder = 100000;

function openOrderModal(serviceId, serviceName, rate, min, max, dripFeedEnabled, refillEnabled) {
    document.getElementById('orderModal').classList.remove('hidden');
    document.getElementById('orderModal').classList.add('flex');
    document.getElementById('modal_service_id').value = serviceId;
    document.getElementById('modal_service_name').value = serviceName;
    document.getElementById('modal_range').textContent = min + ' - ' + max;
    
    currentRate = parseFloat(rate);
    minOrder = min;
    maxOrder = max;
    
    if (dripFeedEnabled) {
        document.getElementById('dripFeedSection').classList.remove('hidden');
    } else {
        document.getElementById('dripFeedSection').classList.add('hidden');
    }
    
    updateTotal();
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.add('hidden');
    document.getElementById('orderModal').classList.remove('flex');
}

function updateTotal() {
    const quantity = parseInt(document.getElementById('modal_quantity').value) || 0;
    const total = (currentRate / 1000) * quantity;
    document.getElementById('total_charge').textContent = '$' + total.toFixed(2);
}

document.getElementById('modal_quantity').addEventListener('input', updateTotal);
document.getElementById('drip_feed').addEventListener('change', function() {
    document.getElementById('dripFeedOptions').classList.toggle('hidden', !this.checked);
});
</script>
{% endblock %}

