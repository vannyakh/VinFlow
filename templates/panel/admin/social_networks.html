{% extends 'panel/admin/base.html' %}
{% load i18n %}

{% block title %}{% trans "Social Networks Management" %} - VinFlow{% endblock %}

{% block admin_content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">{% trans "Social Networks Management" %}</h1>
        <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="btn-primary">
            {% trans "Add Social Network" %}
        </button>
    </div>
    
    <!-- Search and Filters -->
    <div class="card-glass rounded-xl p-4">
        <form method="get" class="space-y-4">
            <div class="flex gap-4 flex-wrap">
                <input type="text" name="search" value="{{ search }}" placeholder="{% trans 'Search by name, platform code...' %}" class="flex-1 min-w-[200px] bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                <select name="status" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <option value="">{% trans "All Status" %}</option>
                    {% for code, label in status_choices %}
                    <option value="{{ code }}" {% if status_filter == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                <select name="active" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <option value="">{% trans "All Active Status" %}</option>
                    <option value="true" {% if active_filter == 'true' %}selected{% endif %}>{% trans "Active" %}</option>
                    <option value="false" {% if active_filter == 'false' %}selected{% endif %}>{% trans "Inactive" %}</option>
                </select>
                {% if per_page %}<input type="hidden" name="per_page" value="{{ per_page }}">{% endif %}
                <button type="submit" class="btn-primary">{% trans "Filter" %}</button>
                {% if search or status_filter or active_filter %}
                <a href="{% url 'admin_social_networks' %}{% if per_page %}?per_page={{ per_page }}{% endif %}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">{% trans "Clear" %}</a>
                {% endif %}
            </div>
        </form>
    </div>
    
    <!-- Social Networks Table -->
    <div class="card-glass rounded-xl p-6">
        <div class="mb-4 flex justify-between items-center flex-wrap gap-4">
            <div class="text-sm text-gray-400">
                {% trans "Showing" %} {{ social_networks.start_index }} - {{ social_networks.end_index }} {% trans "of" %} {{ social_networks.paginator.count }} {% trans "social networks" %}
            </div>
            <form method="get" class="flex items-center gap-2">
                {% if search %}<input type="hidden" name="search" value="{{ search }}">{% endif %}
                {% if status_filter %}<input type="hidden" name="status" value="{{ status_filter }}">{% endif %}
                {% if active_filter %}<input type="hidden" name="active" value="{{ active_filter }}">{% endif %}
                <label for="per_page" class="text-sm text-gray-400">{% trans "Items per page:" %}</label>
                <select name="per_page" id="per_page" onchange="this.form.submit()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1 text-sm">
                    {% for option in per_page_options %}
                    <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-700">
                        <th class="text-left py-3 px-4">{% trans "Icon" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Platform Code" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Name" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Name (Khmer)" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Status" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Active" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Featured" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Order" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for network in social_networks %}
                    <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                        <td class="py-3 px-4">
                            {% if network.icon_image %}
                                <img src="{{ network.icon_image.url }}" alt="{{ network.name }}" class="w-8 h-8 object-contain">
                            {% elif network.icon %}
                                <i class="{{ network.icon }}" style="font-size: 24px; color: {{ network.color }};"></i>
                            {% else %}
                                <i class="{{ network.get_icon_class }}" style="font-size: 24px; color: {{ network.color }};"></i>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 font-mono text-sm">{{ network.platform_code }}</td>
                        <td class="py-3 px-4">{{ network.name }}</td>
                        <td class="py-3 px-4">{{ network.name_km|default:"-" }}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs
                                {% if network.status == 'active' %}bg-green-900/50 text-green-400
                                {% elif network.status == 'inactive' %}bg-red-900/50 text-red-400
                                {% elif network.status == 'maintenance' %}bg-yellow-900/50 text-yellow-400
                                {% else %}bg-gray-900/50 text-gray-400{% endif %}">
                                {{ network.get_status_display }}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs {% if network.is_active %}bg-green-900/50 text-green-400{% else %}bg-red-900/50 text-red-400{% endif %}">
                                {% if network.is_active %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs {% if network.is_featured %}bg-purple-900/50 text-purple-400{% else %}bg-gray-900/50 text-gray-400{% endif %}">
                                {% if network.is_featured %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}
                            </span>
                        </td>
                        <td class="py-3 px-4">{{ network.display_order }}</td>
                        <td class="py-3 px-4">
                            <button onclick="editNetwork({{ network.id }}, '{{ network.platform_code|escapejs }}', '{{ network.name|escapejs }}', '{{ network.name_km|default:""|escapejs }}', '{{ network.description|default:""|escapejs }}', '{{ network.description_km|default:""|escapejs }}', '{{ network.icon|default:""|escapejs }}', '{{ network.color|default:"#000000" }}', '{{ network.status }}', {% if network.is_active %}true{% else %}false{% endif %}, {% if network.is_featured %}true{% else %}false{% endif %}, {{ network.display_order }}, '{{ network.website_url|default:""|escapejs }}', '{{ network.documentation_url|default:""|escapejs }}')" class="text-purple-400 hover:text-purple-300 text-sm mr-2">
                                {% trans "Edit" %}
                            </button>
                            <form method="post" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="network_id" value="{{ network.id }}">
                                <button type="submit" name="action" value="delete" class="text-red-400 hover:text-red-300 text-sm" onclick="return confirm('{% trans 'Are you sure?' %}')">
                                    {% trans "Delete" %}
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="py-8 text-center text-gray-400">{% trans "No social networks found" %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if social_networks.has_other_pages %}
        <div class="mt-6 flex items-center justify-between flex-wrap gap-4">
            <div class="text-sm text-gray-400">
                {% trans "Page" %} {{ social_networks.number }} {% trans "of" %} {{ social_networks.paginator.num_pages }}
            </div>
            <div class="flex gap-2 flex-wrap">
                {% if social_networks.has_previous %}
                <a href="?page=1{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "First" %}
                </a>
                <a href="?page={{ social_networks.previous_page_number }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Previous" %}
                </a>
                {% endif %}
                
                {% for num in social_networks.paginator.page_range %}
                    {% if social_networks.number == num %}
                    <span class="px-3 py-2 bg-purple-600 rounded-lg text-sm">{{ num }}</span>
                    {% elif num > social_networks.number|add:'-3' and num < social_networks.number|add:'3' %}
                    <a href="?page={{ num }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                        {{ num }}
                    </a>
                    {% endif %}
                {% endfor %}
                
                {% if social_networks.has_next %}
                <a href="?page={{ social_networks.next_page_number }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Next" %}
                </a>
                <a href="?page={{ social_networks.paginator.num_pages }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Last" %}
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="addModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" onclick="this.classList.add('hidden')">
    <div class="bg-slate-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <h2 class="text-2xl font-bold mb-4" id="modalTitle">{% trans "Add Social Network" %}</h2>
        <form method="post" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="create" id="formAction">
            <input type="hidden" name="network_id" id="networkId">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Platform Code" %} *</label>
                    <select name="platform_code" id="platformCode" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                        <option value="">{% trans "Select Platform" %}</option>
                        {% for code, label in platform_choices %}
                        <option value="{{ code }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Status" %} *</label>
                    <select name="status" id="networkStatus" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                        {% for code, label in status_choices %}
                        <option value="{{ code }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Name" %} *</label>
                    <input type="text" name="name" id="networkName" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Name (Khmer)" %}</label>
                    <input type="text" name="name_km" id="networkNameKm" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Description" %}</label>
                <textarea name="description" id="networkDescription" rows="2" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2"></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Description (Khmer)" %}</label>
                <textarea name="description_km" id="networkDescriptionKm" rows="2" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2"></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Icon Class" %}</label>
                    <input type="text" name="icon" id="networkIcon" placeholder="fab fa-instagram" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <p class="text-xs text-gray-400 mt-1">{% trans "Font Awesome icon class" %}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Color" %}</label>
                    <input type="color" name="color" id="networkColor" value="#000000" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 h-10">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Icon Image" %}</label>
                    <input type="file" name="icon_image" id="networkIconImage" accept="image/*" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Logo" %}</label>
                    <input type="file" name="logo" id="networkLogo" accept="image/*" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Website URL" %}</label>
                    <input type="url" name="website_url" id="networkWebsiteUrl" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Documentation URL" %}</label>
                    <input type="url" name="documentation_url" id="networkDocumentationUrl" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Display Order" %}</label>
                    <input type="number" name="display_order" id="networkDisplayOrder" value="0" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="is_active" id="networkActive" class="rounded" checked>
                        <span>{% trans "Active" %}</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="is_featured" id="networkFeatured" class="rounded">
                        <span>{% trans "Featured" %}</span>
                    </label>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" class="flex-1 btn-primary">{% trans "Save" %}</button>
                <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">
                    {% trans "Cancel" %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function editNetwork(id, platformCode, name, nameKm, description, descriptionKm, icon, color, status, isActive, isFeatured, displayOrder, websiteUrl, documentationUrl) {
    document.getElementById('modalTitle').textContent = '{% trans "Edit Social Network" %}';
    document.getElementById('formAction').value = 'update';
    document.getElementById('networkId').value = id;
    document.getElementById('platformCode').value = platformCode;
    document.getElementById('platformCode').disabled = true; // Can't change platform code
    document.getElementById('networkName').value = name;
    document.getElementById('networkNameKm').value = nameKm || '';
    document.getElementById('networkDescription').value = description || '';
    document.getElementById('networkDescriptionKm').value = descriptionKm || '';
    document.getElementById('networkIcon').value = icon || '';
    document.getElementById('networkColor').value = color || '#000000';
    document.getElementById('networkStatus').value = status;
    document.getElementById('networkActive').checked = isActive;
    document.getElementById('networkFeatured').checked = isFeatured;
    document.getElementById('networkDisplayOrder').value = displayOrder;
    document.getElementById('networkWebsiteUrl').value = websiteUrl || '';
    document.getElementById('networkDocumentationUrl').value = documentationUrl || '';
    document.getElementById('addModal').classList.remove('hidden');
}

// Reset form when closing modal
document.getElementById('addModal').addEventListener('click', function(e) {
    if (e.target === this) {
        document.getElementById('platformCode').disabled = false;
        document.getElementById('formAction').value = 'create';
        document.getElementById('networkId').value = '';
        document.getElementById('addModal').classList.add('hidden');
    }
});
</script>
{% endblock %}

