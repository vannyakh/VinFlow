{% extends 'panel/admin/base.html' %}
{% load i18n %}

{% block title %}{% trans "User Groups & Permissions" %} - VinFlow{% endblock %}

{% block admin_content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">{% trans "User Groups & Permissions" %}</h1>
        <button onclick="showCreateGroupModal()" class="btn-primary">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            {% trans "Create New Group" %}
        </button>
    </div>
    
    <p class="text-gray-400 text-sm">
        {% trans "Manage user groups and their permissions. Groups allow you to assign multiple permissions to users at once." %}
        <a href="/django-admin/auth/group/" target="_blank" class="text-cyan-400 hover:underline">{% trans "Advanced Management" %}</a>
    </p>
    
    <!-- Search -->
    <div class="card-glass rounded-xl p-4">
        <form method="get" class="flex gap-4">
            <input type="text" name="search" value="{{ search }}" placeholder="{% trans 'Search groups...' %}" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            <button type="submit" class="btn-primary">{% trans "Search" %}</button>
        </form>
    </div>
    
    <!-- Groups Table -->
    <div class="card-glass rounded-xl p-6">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-700">
                        <th class="text-left py-3 px-4">{% trans "Group Name" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Users" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Permissions" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in groups %}
                    <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                        <td class="py-3 px-4 font-semibold">{{ group.name }}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs bg-blue-900/50 text-blue-400">
                                {{ group.user_set.count }} {% trans "users" %}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs bg-green-900/50 text-green-400">
                                {{ group.permissions.count }} {% trans "permissions" %}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex gap-2">
                                <button onclick="showEditGroupModal({{ group.id }})" class="text-xs px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-white">
                                    {% trans "Edit" %}
                                </button>
                                <button onclick="showDeleteGroupModal({{ group.id }}, '{{ group.name }}', {{ group.user_set.count }})" class="text-xs px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-white">
                                    {% trans "Delete" %}
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="py-8 text-center text-gray-400">
                            {% trans "No groups found" %}
                            <br>
                            <a href="/django-admin/auth/group/add/" target="_blank" class="text-cyan-400 hover:underline mt-2 inline-block">
                                {% trans "Create your first group" %}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Permissions Info -->
    <div class="card-glass rounded-xl p-6">
        <h2 class="text-xl font-bold mb-4">{% trans "About Groups & Permissions" %}</h2>
        <div class="space-y-2 text-gray-400 text-sm">
            <p>• <strong class="text-white">{% trans "Groups" %}:</strong> {% trans "Collections of permissions that can be assigned to multiple users" %}</p>
            <p>• <strong class="text-white">{% trans "Permissions" %}:</strong> {% trans "Specific actions users can perform (e.g., 'Can add order', 'Can change service')" %}</p>
            <p>• <strong class="text-white">{% trans "Custom Roles" %}:</strong> {% trans "Your system uses custom roles (Admin, Reseller, User) which work alongside Django groups" %}</p>
            <p>• <strong class="text-white">{% trans "Best Practice" %}:</strong> {% trans "Use groups for fine-grained permissions, and custom roles for high-level access control" %}</p>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">{% trans "Create New Group" %}</h3>
                <button onclick="closeCreateGroupModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="createGroupForm" method="post">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Group Name" %} <span class="text-red-400">*</span></label>
                        <input type="text" id="create_group_name" name="name" required
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white"
                               placeholder="{% trans 'Enter group name' %}">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Permissions" %}</label>
                        <div class="bg-slate-700 border border-slate-600 rounded-lg p-4 max-h-96 overflow-y-auto">
                            {% for app_label, models in permissions_by_app.items %}
                            <div class="mb-4">
                                <h4 class="text-sm font-semibold text-cyan-400 mb-2">{{ app_label|capfirst }}</h4>
                                {% for model_name, perms in models.items %}
                                <div class="ml-4 mb-3">
                                    <h5 class="text-xs font-medium text-gray-300 mb-1">{{ model_name|capfirst }}</h5>
                                    <div class="ml-2 space-y-1">
                                        {% for perm in perms %}
                                        <div class="flex items-center gap-2 p-1">
                                            {% include 'panel/components/ios_checkbox.html' with name="permissions" value=perm.id color="purple" label=perm.name class="create-permission-checkbox" %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% empty %}
                            <p class="text-gray-400 text-sm">{% trans "No permissions available" %}</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div id="createGroupError" class="hidden bg-red-900/50 border border-red-500 rounded-lg p-3 text-red-300 text-sm"></div>
                    <div id="createGroupSuccess" class="hidden bg-green-900/50 border border-green-500 rounded-lg p-3 text-green-300 text-sm"></div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn-primary flex-1">{% trans "Create Group" %}</button>
                    <button type="button" onclick="closeCreateGroupModal()" class="btn-secondary flex-1">{% trans "Cancel" %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div id="editGroupModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">{% trans "Edit Group" %}</h3>
                <button onclick="closeEditGroupModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="editGroupForm" method="post">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Group Name" %} <span class="text-red-400">*</span></label>
                        <input type="text" id="edit_group_name" name="name" required
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Permissions" %}</label>
                        <div class="bg-slate-700 border border-slate-600 rounded-lg p-4 max-h-96 overflow-y-auto">
                            {% for app_label, models in permissions_by_app.items %}
                            <div class="mb-4">
                                <h4 class="text-sm font-semibold text-cyan-400 mb-2">{{ app_label|capfirst }}</h4>
                                {% for model_name, perms in models.items %}
                                <div class="ml-4 mb-3">
                                    <h5 class="text-xs font-medium text-gray-300 mb-1">{{ model_name|capfirst }}</h5>
                                    <div class="ml-2 space-y-1">
                                        {% for perm in perms %}
                                        <div class="flex items-center gap-2 p-1 hover:bg-slate-600 rounded">
                                            {% include 'panel/components/ios_checkbox.html' with name="permissions" value=perm.id color="purple" label=perm.name class="edit-permission-checkbox" %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% empty %}
                            <p class="text-gray-400 text-sm">{% trans "No permissions available" %}</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div id="editGroupError" class="hidden bg-red-900/50 border border-red-500 rounded-lg p-3 text-red-300 text-sm"></div>
                    <div id="editGroupSuccess" class="hidden bg-green-900/50 border border-green-500 rounded-lg p-3 text-green-300 text-sm"></div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn-primary flex-1">{% trans "Save Changes" %}</button>
                    <button type="button" onclick="closeEditGroupModal()" class="btn-secondary flex-1">{% trans "Cancel" %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Group Modal -->
    <div id="deleteGroupModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-red-400">{% trans "Delete Group" %}</h3>
                <button onclick="closeDeleteGroupModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="deleteGroupForm" method="post">
                {% csrf_token %}
                <div class="space-y-4">
                    <p class="text-gray-300">
                        {% trans "Are you sure you want to delete the group" %} <strong id="deleteGroupName" class="text-white"></strong>?
                    </p>
                    <div id="deleteGroupWarning" class="hidden bg-yellow-900/50 border border-yellow-500 rounded-lg p-3 text-yellow-300 text-sm">
                        <p id="deleteGroupWarningText"></p>
                    </div>
                    <div id="deleteGroupError" class="hidden bg-red-900/50 border border-red-500 rounded-lg p-3 text-red-300 text-sm"></div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn-primary bg-red-600 hover:bg-red-700 flex-1">{% trans "Delete" %}</button>
                    <button type="button" onclick="closeDeleteGroupModal()" class="btn-secondary flex-1">{% trans "Cancel" %}</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentEditGroupId = null;
        
        // Create Group Modal Functions
        function showCreateGroupModal() {
            const modal = document.getElementById('createGroupModal');
            const form = document.getElementById('createGroupForm');
            const errorDiv = document.getElementById('createGroupError');
            const successDiv = document.getElementById('createGroupSuccess');
            
            // Reset form and hide messages
            form.reset();
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Set form action
            form.action = '{% url "admin_create_group" %}';
            
            modal.classList.remove('hidden');
        }
        
        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').classList.add('hidden');
            document.getElementById('createGroupForm').reset();
            document.getElementById('createGroupError').classList.add('hidden');
            document.getElementById('createGroupSuccess').classList.add('hidden');
        }
        
        // Handle create group form submission
        document.getElementById('createGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const errorDiv = document.getElementById('createGroupError');
            const successDiv = document.getElementById('createGroupSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            form.style.opacity = '0.5';
            form.style.pointerEvents = 'none';
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    successDiv.textContent = data.message || 'Group created successfully';
                    successDiv.classList.remove('hidden');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    errorDiv.textContent = data.message || 'Failed to create group';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Error creating group: ' + error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        });
        
        // Edit Group Modal Functions
        async function showEditGroupModal(groupId) {
            currentEditGroupId = groupId;
            const modal = document.getElementById('editGroupModal');
            const form = document.getElementById('editGroupForm');
            const errorDiv = document.getElementById('editGroupError');
            const successDiv = document.getElementById('editGroupSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            form.style.opacity = '0.5';
            form.style.pointerEvents = 'none';
            
            try {
                const response = await fetch(`/admin/user-groups/${groupId}/edit/`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('edit_group_name').value = data.name || '';
                    
                    // Show modal first so checkboxes are in DOM
                    modal.classList.remove('hidden');
                    
                    // Wait a bit for DOM to be ready, then set permissions
                    setTimeout(() => {
                        // Set permissions - find input checkboxes directly within edit modal
                        const permissionInputs = document.querySelectorAll('#editGroupModal input.edit-permission-checkbox[type="checkbox"]');
                        permissionInputs.forEach(input => {
                            const isChecked = data.permissions.includes(parseInt(input.value));
                            input.checked = isChecked;
                            // Trigger change event to ensure CSS updates
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                        });
                    }, 100);
                    
                    form.action = `/admin/user-groups/${groupId}/edit/`;
                } else {
                    errorDiv.textContent = data.message || 'Failed to load group data';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Error loading group data: ' + error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        }
        
        function closeEditGroupModal() {
            document.getElementById('editGroupModal').classList.add('hidden');
            document.getElementById('editGroupForm').reset();
            document.getElementById('editGroupError').classList.add('hidden');
            document.getElementById('editGroupSuccess').classList.add('hidden');
            currentEditGroupId = null;
        }
        
        // Handle edit group form submission
        document.getElementById('editGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const errorDiv = document.getElementById('editGroupError');
            const successDiv = document.getElementById('editGroupSuccess');
            
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            form.style.opacity = '0.5';
            form.style.pointerEvents = 'none';
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    successDiv.textContent = data.message || 'Group updated successfully';
                    successDiv.classList.remove('hidden');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    errorDiv.textContent = data.message || 'Failed to update group';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Error updating group: ' + error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        });
        
        // Delete Group Modal Functions
        function showDeleteGroupModal(groupId, groupName, userCount) {
            const modal = document.getElementById('deleteGroupModal');
            const form = document.getElementById('deleteGroupForm');
            const nameSpan = document.getElementById('deleteGroupName');
            const warningDiv = document.getElementById('deleteGroupWarning');
            const warningText = document.getElementById('deleteGroupWarningText');
            const errorDiv = document.getElementById('deleteGroupError');
            
            nameSpan.textContent = groupName;
            form.action = `/admin/user-groups/${groupId}/delete/`;
            
            if (userCount > 0) {
                warningText.textContent = `This group has ${userCount} user(s) assigned. You must remove all users before deleting.`;
                warningDiv.classList.remove('hidden');
                form.querySelector('button[type="submit"]').disabled = true;
            } else {
                warningDiv.classList.add('hidden');
                form.querySelector('button[type="submit"]').disabled = false;
            }
            
            errorDiv.classList.add('hidden');
            modal.classList.remove('hidden');
        }
        
        function closeDeleteGroupModal() {
            document.getElementById('deleteGroupModal').classList.add('hidden');
            document.getElementById('deleteGroupError').classList.add('hidden');
        }
        
        // Handle delete group form submission
        document.getElementById('deleteGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const errorDiv = document.getElementById('deleteGroupError');
            
            errorDiv.classList.add('hidden');
            
            form.style.opacity = '0.5';
            form.style.pointerEvents = 'none';
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    errorDiv.textContent = data.message || 'Failed to delete group';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Error deleting group: ' + error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        });
        
        // Close modals on outside click
        document.addEventListener('DOMContentLoaded', function() {
            ['createGroupModal', 'editGroupModal', 'deleteGroupModal'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            if (modalId === 'createGroupModal') closeCreateGroupModal();
                            else if (modalId === 'editGroupModal') closeEditGroupModal();
                            else if (modalId === 'deleteGroupModal') closeDeleteGroupModal();
                        }
                    });
                }
            });
        });
    </script>
</div>
{% endblock %}

