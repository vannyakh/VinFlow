{% extends 'panel/admin/base.html' %}
{% load i18n %}

{% block title %}{% trans "Categories Management" %} - VinFlow{% endblock %}

{% block admin_content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">{% trans "Categories Management" %}</h1>
        <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="btn-primary">
            {% trans "Add Category" %}
        </button>
    </div>
    
    <!-- Search and Filters -->
    <div class="card-glass rounded-xl p-4">
        <form method="get" class="space-y-4">
            <div class="flex gap-4 flex-wrap">
                <input type="text" name="search" value="{{ search }}" placeholder="{% trans 'Search categories...' %}" class="flex-1 min-w-[200px] bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                <select name="status" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <option value="">{% trans "All Status" %}</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>{% trans "Active" %}</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>{% trans "Inactive" %}</option>
                </select>
                {% if per_page %}<input type="hidden" name="per_page" value="{{ per_page }}">{% endif %}
                <button type="submit" class="btn-primary">{% trans "Filter" %}</button>
                {% if search or status_filter %}
                <a href="{% url 'admin_categories' %}{% if per_page %}?per_page={{ per_page }}{% endif %}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">{% trans "Clear" %}</a>
                {% endif %}
            </div>
        </form>
    </div>
    
    <!-- Categories Table -->
    <div class="card-glass rounded-xl p-6">
        <div class="mb-4 flex justify-between items-center flex-wrap gap-4">
            <div class="text-sm text-gray-400">
                {% trans "Showing" %} {{ categories.start_index }} - {{ categories.end_index }} {% trans "of" %} {{ categories.paginator.count }} {% trans "categories" %}
            </div>
            <form method="get" class="flex items-center gap-2">
                {% if search %}<input type="hidden" name="search" value="{{ search }}">{% endif %}
                {% if status_filter %}<input type="hidden" name="status" value="{{ status_filter }}">{% endif %}
                <label for="per_page" class="text-sm text-gray-400">{% trans "Items per page:" %}</label>
                <select name="per_page" id="per_page" onchange="this.form.submit()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1 text-sm">
                    {% for option in per_page_options %}
                    <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-700">
                        <th class="text-left py-3 px-4">{% trans "Name" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Name (Khmer)" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Social Network" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Order" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Status" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in categories %}
                    <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                        <td class="py-3 px-4">{{ category.name }}</td>
                        <td class="py-3 px-4">{{ category.name_km|default:"-" }}</td>
                        <td class="py-3 px-4">
                            {% if category.social_network %}
                                <div class="flex items-center gap-2">
                                    {% if category.social_network.icon_image %}
                                        <img src="{{ category.social_network.icon_image.url }}" alt="{{ category.social_network.name }}" class="w-5 h-5 object-contain">
                                    {% elif category.social_network.icon %}
                                        <i class="{{ category.social_network.icon }}" style="color: {{ category.social_network.color }}"></i>
                                    {% else %}
                                        <i class="{{ category.social_network.get_icon_class }}" style="color: {{ category.social_network.color }}"></i>
                                    {% endif %}
                                    <span class="text-sm">{{ category.social_network.name }}</span>
                                </div>
                            {% else %}
                                <span class="text-gray-500 text-sm">-</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">{{ category.order }}</td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded text-xs {% if category.is_active %}bg-green-900/50 text-green-400{% else %}bg-red-900/50 text-red-400{% endif %}">
                                {% if category.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <button onclick="editCategory({{ category.id }}, '{{ category.name|escapejs }}', '{{ category.name_km|default:""|escapejs }}', {{ category.order }}, {% if category.is_active %}true{% else %}false{% endif %}, {{ category.social_network.id|default:'null' }})" class="text-purple-400 hover:text-purple-300 text-sm mr-2">
                                {% trans "Edit" %}
                            </button>
                            <form method="post" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="category_id" value="{{ category.id }}">
                                <button type="submit" name="action" value="delete" class="text-red-400 hover:text-red-300 text-sm" onclick="return confirm('{% trans 'Are you sure?' %}')">
                                    {% trans "Delete" %}
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="py-8 text-center text-gray-400">{% trans "No categories found" %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if categories.has_other_pages %}
        <div class="mt-6 flex items-center justify-between flex-wrap gap-4">
            <div class="text-sm text-gray-400">
                {% trans "Page" %} {{ categories.number }} {% trans "of" %} {{ categories.paginator.num_pages }}
            </div>
            <div class="flex gap-2 flex-wrap">
                {% if categories.has_previous %}
                <a href="?page=1{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "First" %}
                </a>
                <a href="?page={{ categories.previous_page_number }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Previous" %}
                </a>
                {% endif %}
                
                {% for num in categories.paginator.page_range %}
                    {% if categories.number == num %}
                    <span class="px-3 py-2 bg-purple-600 rounded-lg text-sm">{{ num }}</span>
                    {% elif num > categories.number|add:'-3' and num < categories.number|add:'3' %}
                    <a href="?page={{ num }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                        {{ num }}
                    </a>
                    {% endif %}
                {% endfor %}
                
                {% if categories.has_next %}
                <a href="?page={{ categories.next_page_number }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Next" %}
                </a>
                <a href="?page={{ categories.paginator.num_pages }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Last" %}
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="addModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" onclick="this.classList.add('hidden')">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <h2 class="text-2xl font-bold mb-4" id="modalTitle">{% trans "Add Category" %}</h2>
        <form method="post" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="create" id="formAction">
            <input type="hidden" name="category_id" id="categoryId">
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Name" %} *</label>
                <input type="text" name="name" id="categoryName" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Name (Khmer)" %}</label>
                <input type="text" name="name_km" id="categoryNameKm" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Social Network" %}</label>
                <select name="social_network_id" id="categorySocialNetwork" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                    <option value="">{% trans "None" %}</option>
                    {% for network in social_networks %}
                    <option value="{{ network.id }}" data-icon="{{ network.get_icon_class }}" data-color="{{ network.color }}">
                        {{ network.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Order" %}</label>
                <input type="number" name="order" id="categoryOrder" value="0" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            </div>
            <div>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="is_active" id="categoryActive" class="rounded">
                    <span>{% trans "Active" %}</span>
                </label>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="flex-1 btn-primary">{% trans "Save" %}</button>
                <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">
                    {% trans "Cancel" %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function editCategory(id, name, nameKm, order, isActive, socialNetworkId) {
    document.getElementById('modalTitle').textContent = '{% trans "Edit Category" %}';
    document.getElementById('formAction').value = 'update';
    document.getElementById('categoryId').value = id;
    document.getElementById('categoryName').value = name;
    document.getElementById('categoryNameKm').value = nameKm || '';
    document.getElementById('categoryOrder').value = order;
    document.getElementById('categoryActive').checked = isActive;
    document.getElementById('categorySocialNetwork').value = socialNetworkId || '';
    document.getElementById('addModal').classList.remove('hidden');
}
</script>
{% endblock %}

