{% extends 'panel/admin/base.html' %}
{% load i18n %}

{% block title %}{% trans "Settings & Configuration" %} - VinFlow{% endblock %}

{% block admin_content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">{% trans "Settings & Configuration" %}</h1>
        <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="btn-primary">
            {% trans "Add Setting" %}
        </button>
    </div>
    
    <!-- Group Filter Tabs -->
    <div class="card-glass rounded-xl p-4">
        <div class="flex gap-2 flex-wrap">
            <a href="{% url 'admin_settings' %}" class="px-4 py-2 rounded-lg {% if not group_filter %}bg-purple-600{% else %}bg-slate-700 hover:bg-slate-600{% endif %} text-sm transition">
                {% trans "All" %}
            </a>
            {% for group_key, group_label in setting_groups %}
            <a href="{% url 'admin_settings' %}?group={{ group_key }}" class="px-4 py-2 rounded-lg {% if group_filter == group_key %}bg-purple-600{% else %}bg-slate-700 hover:bg-slate-600{% endif %} text-sm transition">
                {% trans group_label %}
            </a>
            {% endfor %}
        </div>
    </div>
    
    <!-- Settings by Group -->
    {% for group_key, group_label in setting_groups %}
        {% if not group_filter or group_filter == group_key %}
            {% for group, settings_list in grouped_settings.items %}
                {% if group == group_key %}
            <div class="card-glass rounded-xl p-6">
                <h2 class="text-xl font-bold mb-4 text-purple-400">{% trans group_label %}</h2>
                <form method="post" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update">
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-slate-700">
                                    <th class="text-left py-3 px-4">{% trans "Setting" %}</th>
                                    <th class="text-left py-3 px-4">{% trans "Value" %}</th>
                                    <th class="text-left py-3 px-4">{% trans "Type" %}</th>
                                    <th class="text-left py-3 px-4">{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for setting in settings_list %}
                                <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                                    <td class="py-3 px-4">
                                        <div>
                                            <div class="font-medium">{{ setting.label }}</div>
                                            <div class="text-xs text-gray-400 mt-1">{{ setting.key }}</div>
                                            {% if setting.description %}
                                            <div class="text-xs text-gray-500 mt-1">{{ setting.description }}</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="py-3 px-4">
                                        {% if setting.setting_type == 'boolean' %}
                                            <label class="flex items-center space-x-3">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" name="setting_{{ setting.id }}" 
                                                           {% if setting.get_bool_value %}checked{% endif %}>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="text-sm text-gray-400">
                                                    {% if setting.get_bool_value %}{% trans "Enabled" %}{% else %}{% trans "Disabled" %}{% endif %}
                                                </span>
                                            </label>
                                        {% elif setting.setting_type == 'textarea' %}
                                            <textarea name="setting_{{ setting.id }}" 
                                                      class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm" 
                                                      rows="3">{{ setting.get_value }}</textarea>
                                        {% elif setting.setting_type == 'number' %}
                                            <input type="number" name="setting_{{ setting.id }}" 
                                                   value="{{ setting.get_value }}" 
                                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm">
                                        {% elif setting.setting_type == 'email' %}
                                            <input type="email" name="setting_{{ setting.id }}" 
                                                   value="{{ setting.get_value }}" 
                                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm">
                                        {% elif setting.setting_type == 'url' %}
                                            <input type="url" name="setting_{{ setting.id }}" 
                                                   value="{{ setting.get_value }}" 
                                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm">
                                        {% elif setting.setting_type == 'image' %}
                                            <div class="space-y-2">
                                                {% if setting.get_value %}
                                                <div class="relative inline-block">
                                                    <img src="/{{ setting.get_value }}" alt="{{ setting.label }}" 
                                                         class="max-w-xs max-h-32 rounded-lg border border-slate-600">
                                                </div>
                                                {% endif %}
                                                <label class="block">
                                                    <span class="sr-only">{% trans "Choose image file" %}</span>
                                                    <input type="file" name="image_{{ setting.id }}" 
                                                           accept="image/*" 
                                                           class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 file:cursor-pointer cursor-pointer bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                                                </label>
                                                <input type="text" name="setting_{{ setting.id }}" 
                                                       value="{{ setting.get_value }}" 
                                                       placeholder="{% trans 'Or enter image URL/path' %}"
                                                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm mt-2">
                                            </div>
                                        {% elif setting.setting_type == 'image_list' %}
                                            <div class="space-y-3">
                                                {% if setting.image_list %}
                                                    <div class="flex flex-wrap gap-2 mb-2" id="imageList_{{ setting.id }}">
                                                        {% for image_path in setting.image_list %}
                                                        <div class="relative group">
                                                            <img src="/{{ image_path }}" alt="Image {{ forloop.counter }}" 
                                                                 class="w-24 h-24 object-cover rounded-lg border border-slate-600">
                                                            <button type="button" onclick="removeImage({{ setting.id }}, {{ forloop.counter0 }})" 
                                                                    class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                                                Ã—
                                                            </button>
                                                            <input type="hidden" name="remove_images_{{ setting.id }}" value="{{ forloop.counter0 }}">
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="flex flex-wrap gap-2 mb-2" id="imageList_{{ setting.id }}"></div>
                                                {% endif %}
                                                <label class="block">
                                                    <span class="sr-only">{% trans "Choose image files" %}</span>
                                                    <input type="file" name="images_{{ setting.id }}" 
                                                           accept="image/*" multiple
                                                           class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 file:cursor-pointer cursor-pointer bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                                                </label>
                                            </div>
                                        {% else %}
                                            <input type="text" name="setting_{{ setting.id }}" 
                                                   value="{{ setting.get_value }}" 
                                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-sm">
                                        {% endif %}
                                        {% if setting.default_value and not setting.value %}
                                        <div class="text-xs text-gray-500 mt-1">
                                            {% trans "Default" %}: {{ setting.default_value }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded text-xs bg-slate-700 text-gray-300">
                                            {{ setting.get_setting_type_display }}
                                        </span>
                                        {% if setting.is_public %}
                                        <span class="px-2 py-1 rounded text-xs bg-green-900/50 text-green-400 ml-1">
                                            {% trans "Public" %}
                                        </span>
                                        {% endif %}
                                        {% if setting.is_encrypted %}
                                        <span class="px-2 py-1 rounded text-xs bg-yellow-900/50 text-yellow-400 ml-1">
                                            {% trans "Encrypted" %}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="py-3 px-4">
                                        <button type="button" onclick="deleteSetting({{ setting.id }}, '{{ setting.label }}')" 
                                                class="text-red-400 hover:text-red-300 text-sm">
                                            {% trans "Delete" %}
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-end mt-4">
                        <button type="submit" class="btn-primary">
                            {% trans "Save Changes" %}
                        </button>
                    </div>
                </form>
            </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}
    
    {% if not grouped_settings %}
    <div class="card-glass rounded-xl p-8 text-center">
        <p class="text-gray-400">{% trans "No settings found" %}</p>
    </div>
    {% endif %}
</div>

<!-- Add/Edit Setting Modal -->
<div id="addModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" onclick="this.classList.add('hidden')">
    <div class="bg-slate-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <h2 class="text-2xl font-bold mb-4">{% trans "Add New Setting" %}</h2>
        <form method="post" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Key" %} *</label>
                    <input type="text" name="key" required 
                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2"
                           placeholder="e.g., site_name">
                    <p class="text-xs text-gray-400 mt-1">{% trans "Unique identifier (lowercase, underscores)" %}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Label" %} *</label>
                    <input type="text" name="label" required 
                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2"
                           placeholder="Site Name">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Type" %} *</label>
                    <select name="setting_type" required 
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                        {% for type_key, type_label in setting_types %}
                        <option value="{{ type_key }}">{% trans type_label %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Group" %} *</label>
                    <select name="group" required 
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                        {% for group_key, group_label in setting_groups %}
                        <option value="{{ group_key }}">{% trans group_label %}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Default Value" %}</label>
                <input type="text" name="default_value" 
                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">{% trans "Description" %}</label>
                <textarea name="description" rows="3" 
                          class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">{% trans "Order" %}</label>
                    <input type="number" name="order" value="0" 
                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                </div>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3">
                        <label class="toggle-switch">
                            <input type="checkbox" name="is_public">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="text-sm text-gray-300">{% trans "Public (API accessible)" %}</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <label class="toggle-switch">
                            <input type="checkbox" name="is_encrypted">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="text-sm text-gray-300">{% trans "Encrypted" %}</span>
                    </label>
                </div>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="flex-1 btn-primary">{% trans "Create Setting" %}</button>
                <button type="button" onclick="document.getElementById('addModal').classList.add('hidden')" 
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">
                    {% trans "Cancel" %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50" onclick="this.classList.add('hidden')">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <h2 class="text-2xl font-bold mb-4 text-red-400">{% trans "Delete Setting" %}</h2>
        <p class="mb-4">{% trans "Are you sure you want to delete this setting?" %}</p>
        <p class="mb-4 text-sm text-gray-400" id="deleteSettingName"></p>
        <form method="post" id="deleteForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="setting_id" id="deleteSettingId">
            <div class="flex gap-2">
                <button type="submit" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg">
                    {% trans "Delete" %}
                </button>
                <button type="button" onclick="document.getElementById('deleteModal').classList.add('hidden')" 
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">
                    {% trans "Cancel" %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function deleteSetting(id, name) {
    document.getElementById('deleteSettingId').value = id;
    document.getElementById('deleteSettingName').textContent = name;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function removeImage(settingId, index) {
    const hiddenInput = document.querySelector(`input[name="remove_images_${settingId}"][value="${index}"]`);
    if (hiddenInput) {
        hiddenInput.closest('.relative').remove();
    }
}

</script>
{% endblock %}

