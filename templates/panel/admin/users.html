{% extends 'panel/admin/base.html' %}
{% load i18n %}

{% block title %}{% trans "Users Management" %} - VinFlow{% endblock %}

{% block admin_content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">{% trans "Users Management" %}</h1>
        <button onclick="showCreateModal()" class="btn-primary">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            {% trans "Create User" %}
        </button>
    </div>
    
    <!-- Filters -->
    <div class="card-glass rounded-xl p-4">
        <form method="get" class="flex gap-4 flex-wrap">
            <input type="text" name="search" value="{{ search }}" placeholder="{% trans 'Search users...' %}" class="flex-1 min-w-[200px] bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
            <select name="role" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                <option value="">{% trans "All Roles" %}</option>
                <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>{% trans "Admin" %}</option>
                <option value="reseller" {% if role_filter == 'reseller' %}selected{% endif %}>{% trans "Reseller" %}</option>
                <option value="user" {% if role_filter == 'user' %}selected{% endif %}>{% trans "User" %}</option>
            </select>
            {% if per_page %}<input type="hidden" name="per_page" value="{{ per_page }}">{% endif %}
            <button type="submit" class="btn-primary">{% trans "Filter" %}</button>
            {% if search or role_filter %}
            <a href="{% url 'admin_users' %}{% if per_page %}?per_page={{ per_page }}{% endif %}" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">{% trans "Clear" %}</a>
            {% endif %}
        </form>
    </div>
    
    <!-- Users Table -->
    <div class="card-glass rounded-xl p-6">
        <div class="mb-4 flex justify-between items-center flex-wrap gap-4">
            <div class="text-sm text-gray-400">
                {% trans "Showing" %} {{ users.start_index }} - {{ users.end_index }} {% trans "of" %} {{ users.paginator.count }} {% trans "users" %}
            </div>
            <form method="get" class="flex items-center gap-2">
                {% if search %}<input type="hidden" name="search" value="{{ search }}">{% endif %}
                {% if role_filter %}<input type="hidden" name="role" value="{{ role_filter }}">{% endif %}
                <label for="per_page" class="text-sm text-gray-400">{% trans "Items per page:" %}</label>
                <select name="per_page" id="per_page" onchange="this.form.submit()" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1 text-sm">
                    {% for option in per_page_options %}
                    <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-700">
                        <th class="text-left py-3 px-4">{% trans "Username" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Email" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Role" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Groups" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Balance" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Total Spent" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Joined" %}</th>
                        <th class="text-left py-3 px-4">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                        <td class="py-3 px-4">{{ user.username }}</td>
                        <td class="py-3 px-4">{{ user.email }}</td>
                        <td class="py-3 px-4">
                            <form method="post" action="{% url 'admin_edit_user_role' user.id %}" class="inline-block" onsubmit="return confirm('{% trans 'Are you sure you want to change this user\'s role?' %}');">
                                {% csrf_token %}
                                <select name="role" onchange="this.form.submit()" class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs
                                    {% if user.profile.role == 'admin' %}text-purple-400
                                    {% elif user.profile.role == 'reseller' %}text-cyan-400
                                    {% else %}text-gray-300{% endif %}">
                                    <option value="user" {% if user.profile.role == 'user' %}selected{% endif %}>{% trans "User" %}</option>
                                    <option value="reseller" {% if user.profile.role == 'reseller' %}selected{% endif %}>{% trans "Reseller" %}</option>
                                    <option value="admin" {% if user.profile.role == 'admin' %}selected{% endif %}>{% trans "Admin" %}</option>
                                </select>
                            </form>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex flex-wrap gap-1">
                                {% for group in user.groups.all %}
                                <span class="px-2 py-1 rounded text-xs bg-blue-900/50 text-blue-400">{{ group.name }}</span>
                                {% empty %}
                                <span class="text-xs text-gray-500">{% trans "No groups" %}</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="py-3 px-4">${{ user.profile.balance|floatformat:2 }}</td>
                        <td class="py-3 px-4">${{ user.profile.total_spent|floatformat:2 }}</td>
                        <td class="py-3 px-4 text-sm text-gray-400">{{ user.date_joined|date:"M d, Y" }}</td>
                        <td class="py-3 px-4">
                            <div class="flex gap-2">
                                <button onclick="showEditModal({{ user.id }})" class="text-xs px-2 py-1 bg-purple-600 hover:bg-purple-700 rounded text-white">
                                    {% trans "Edit" %}
                                </button>
                                <button onclick="showGroupModal({{ user.id }}, '{{ user.username }}', [{% for group in user.groups.all %}{{ group.id }}{% if not forloop.last %},{% endif %}{% endfor %}])" class="text-xs px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded">
                                    {% trans "Manage Groups" %}
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="py-8 text-center text-gray-400">{% trans "No users found" %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if users.has_other_pages %}
        <div class="mt-6 flex items-center justify-between flex-wrap gap-4">
            <div class="text-sm text-gray-400">
                {% trans "Page" %} {{ users.number }} {% trans "of" %} {{ users.paginator.num_pages }}
            </div>
            <div class="flex gap-2 flex-wrap">
                {% if users.has_previous %}
                <a href="?page=1{% if search %}&search={{ search|urlencode }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "First" %}
                </a>
                <a href="?page={{ users.previous_page_number }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Previous" %}
                </a>
                {% endif %}
                
                {% for num in users.paginator.page_range %}
                    {% if users.number == num %}
                    <span class="px-3 py-2 bg-purple-600 rounded-lg text-sm">{{ num }}</span>
                    {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
                    <a href="?page={{ num }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                        {{ num }}
                    </a>
                    {% endif %}
                {% endfor %}
                
                {% if users.has_next %}
                <a href="?page={{ users.next_page_number }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Next" %}
                </a>
                <a href="?page={{ users.paginator.num_pages }}{% if search %}&search={{ search|urlencode }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                    {% trans "Last" %}
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">{% trans "Create New User" %}</h3>
                <button onclick="closeCreateModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="createUserForm" method="post">
                {% csrf_token %}
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Username" %} <span class="text-red-400">*</span></label>
                            <input type="text" id="create_username" name="username" required minlength="3"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Email" %} <span class="text-red-400">*</span></label>
                            <input type="email" id="create_email" name="email" required
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Password" %} <span class="text-red-400">*</span></label>
                            <input type="password" id="create_password" name="password" required minlength="8"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Confirm Password" %} <span class="text-red-400">*</span></label>
                            <input type="password" id="create_password_confirm" name="password_confirm" required minlength="8"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "First Name" %}</label>
                            <input type="text" id="create_first_name" name="first_name"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Last Name" %}</label>
                            <input type="text" id="create_last_name" name="last_name"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Role" %}</label>
                            <select id="create_role" name="role" required
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                <option value="user">{% trans "User" %}</option>
                                <option value="reseller">{% trans "Reseller" %}</option>
                                <option value="admin">{% trans "Admin" %}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Status" %}</label>
                            <select id="create_is_active" name="is_active"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                <option value="true">{% trans "Active" %}</option>
                                <option value="false">{% trans "Inactive" %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Initial Balance" %}</label>
                        <input type="number" id="create_balance" name="balance" step="0.01" min="0" value="0.00"
                               class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Groups" %}</label>
                        <div class="bg-slate-700 border border-slate-600 rounded-lg p-3 max-h-48 overflow-y-auto">
                            {% for group in all_groups %}
                            <label class="flex items-center gap-2 p-2 hover:bg-slate-600 rounded cursor-pointer">
                                <input type="checkbox" name="groups" value="{{ group.id }}" class="rounded create-group-checkbox">
                                <span class="flex-1 text-white">{{ group.name }}</span>
                                <span class="text-xs text-gray-400">({{ group.permissions.count }} {% trans "perms" %})</span>
                            </label>
                            {% empty %}
                            <p class="text-gray-400 text-sm">{% trans "No groups available" %}</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div id="createUserError" class="hidden bg-red-900/50 border border-red-500 rounded-lg p-3 text-red-300 text-sm"></div>
                    <div id="createUserSuccess" class="hidden bg-green-900/50 border border-green-500 rounded-lg p-3 text-green-300 text-sm"></div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn-primary flex-1">{% trans "Create User" %}</button>
                    <button type="button" onclick="closeCreateModal()" class="btn-secondary flex-1">{% trans "Cancel" %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">{% trans "Edit User" %}</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="editUserForm" method="post">
                {% csrf_token %}
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Username" %}</label>
                            <input type="text" id="edit_username" name="username" required
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Email" %}</label>
                            <input type="email" id="edit_email" name="email" required
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "First Name" %}</label>
                            <input type="text" id="edit_first_name" name="first_name"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Last Name" %}</label>
                            <input type="text" id="edit_last_name" name="last_name"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Role" %}</label>
                            <select id="edit_role" name="role" required
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                <option value="user">{% trans "User" %}</option>
                                <option value="reseller">{% trans "Reseller" %}</option>
                                <option value="admin">{% trans "Admin" %}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Status" %}</label>
                            <select id="edit_is_active" name="is_active"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                                <option value="true">{% trans "Active" %}</option>
                                <option value="false">{% trans "Inactive" %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Balance" %}</label>
                            <input type="number" id="edit_balance" name="balance" step="0.01" min="0"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Total Spent" %}</label>
                            <input type="number" id="edit_total_spent" name="total_spent" step="0.01" min="0"
                                   class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">{% trans "Groups" %}</label>
                        <div class="bg-slate-700 border border-slate-600 rounded-lg p-3 max-h-48 overflow-y-auto">
                            {% for group in all_groups %}
                            <label class="flex items-center gap-2 p-2 hover:bg-slate-600 rounded cursor-pointer">
                                <input type="checkbox" name="groups" value="{{ group.id }}" class="rounded edit-group-checkbox">
                                <span class="flex-1 text-white">{{ group.name }}</span>
                                <span class="text-xs text-gray-400">({{ group.permissions.count }} {% trans "perms" %})</span>
                            </label>
                            {% empty %}
                            <p class="text-gray-400 text-sm">{% trans "No groups available" %}</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div id="editUserError" class="hidden bg-red-900/50 border border-red-500 rounded-lg p-3 text-red-300 text-sm"></div>
                    <div id="editUserSuccess" class="hidden bg-green-900/50 border border-green-500 rounded-lg p-3 text-green-300 text-sm"></div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button type="submit" class="btn-primary flex-1">{% trans "Save Changes" %}</button>
                    <button type="button" onclick="closeEditModal()" class="btn-secondary flex-1">{% trans "Cancel" %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Management Modal -->
    <div id="groupModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">{% trans "Manage Groups for" %} <span id="modalUsername"></span></h3>
                <button onclick="closeGroupModal()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <form id="groupForm" method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="action" value="update">
                <div class="space-y-3 mb-4 max-h-64 overflow-y-auto" id="groupsList">
                    {% for group in all_groups %}
                    <label class="flex items-center gap-2 p-2 hover:bg-slate-700 rounded cursor-pointer">
                        <input type="checkbox" name="groups" value="{{ group.id }}" class="rounded group-checkbox">
                        <span class="flex-1">{{ group.name }}</span>
                        <span class="text-xs text-gray-400">({{ group.permissions.count }} {% trans "perms" %})</span>
                    </label>
                    {% empty %}
                    <p class="text-gray-400 text-sm">{% trans "No groups available. Create groups in Django admin." %}</p>
                    {% endfor %}
                </div>
                <div class="flex gap-2">
                    <button type="submit" name="action" value="update" class="btn-primary flex-1">{% trans "Update Groups" %}</button>
                    <button type="button" onclick="closeGroupModal()" class="btn-secondary flex-1">{% trans "Cancel" %}</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentEditUserId = null;
        
        // Create User Modal Functions
        function showCreateModal() {
            const modal = document.getElementById('createUserModal');
            const form = document.getElementById('createUserForm');
            const errorDiv = document.getElementById('createUserError');
            const successDiv = document.getElementById('createUserSuccess');
            
            // Reset form and hide messages
            form.reset();
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Set form action
            form.action = '{% url "admin_create_user" %}';
            
            modal.classList.remove('hidden');
        }
        
        function closeCreateModal() {
            document.getElementById('createUserModal').classList.add('hidden');
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserError').classList.add('hidden');
            document.getElementById('createUserSuccess').classList.add('hidden');
        }
        
        function showCreateError(message) {
            const errorDiv = document.getElementById('createUserError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function showCreateSuccess(message) {
            const successDiv = document.getElementById('createUserSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
        }
        
        // Handle create user form submission
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const errorDiv = document.getElementById('createUserError');
            const successDiv = document.getElementById('createUserSuccess');
            
            // Hide previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validate passwords match
            const password = formData.get('password');
            const passwordConfirm = formData.get('password_confirm');
            
            if (password !== passwordConfirm) {
                showCreateError('Passwords do not match');
                return;
            }
            
            // Disable form during submission
            form.style.opacity = '0.5';
            form.style.pointerEvents = 'none';
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    showCreateSuccess(data.message || 'User created successfully');
                    // Reload page after 1.5 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showCreateError(data.message || 'Failed to create user');
                }
            } catch (error) {
                showCreateError('Error creating user: ' + error.message);
            } finally {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        });
        
        // Edit User Modal Functions
        async function showEditModal(userId) {
            currentEditUserId = userId;
            const modal = document.getElementById('editUserModal');
            const form = document.getElementById('editUserForm');
            const errorDiv = document.getElementById('editUserError');
            const successDiv = document.getElementById('editUserSuccess');
            
            // Hide messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Show loading state
            form.style.opacity = '0.5';
            form.style.pointerEvents = 'none';
            
            try {
                // Fetch user data
                const response = await fetch(`/admin/users/${userId}/edit/`);
                const data = await response.json();
                
                if (response.ok) {
                    // Populate form fields
                    document.getElementById('edit_username').value = data.username || '';
                    document.getElementById('edit_email').value = data.email || '';
                    document.getElementById('edit_first_name').value = data.first_name || '';
                    document.getElementById('edit_last_name').value = data.last_name || '';
                    document.getElementById('edit_role').value = data.role || 'user';
                    document.getElementById('edit_is_active').value = data.is_active ? 'true' : 'false';
                    document.getElementById('edit_balance').value = data.balance || '0.00';
                    document.getElementById('edit_total_spent').value = data.total_spent || '0.00';
                    
                    // Set groups
                    const groupCheckboxes = document.querySelectorAll('.edit-group-checkbox');
                    groupCheckboxes.forEach(checkbox => {
                        checkbox.checked = data.groups.includes(parseInt(checkbox.value));
                    });
                    
                    // Update form action
                    form.action = `/admin/users/${userId}/edit/`;
                    
                    modal.classList.remove('hidden');
                } else {
                    showEditError(data.message || 'Failed to load user data');
                }
            } catch (error) {
                showEditError('Error loading user data: ' + error.message);
            } finally {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        }
        
        function closeEditModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            document.getElementById('editUserForm').reset();
            document.getElementById('editUserError').classList.add('hidden');
            document.getElementById('editUserSuccess').classList.add('hidden');
            currentEditUserId = null;
        }
        
        function showEditError(message) {
            const errorDiv = document.getElementById('editUserError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function showEditSuccess(message) {
            const successDiv = document.getElementById('editUserSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
        }
        
        // Handle form submission
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const errorDiv = document.getElementById('editUserError');
            const successDiv = document.getElementById('editUserSuccess');
            
            // Hide previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Disable form during submission
            form.style.opacity = '0.5';
            form.style.pointerEvents = 'none';
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    showEditSuccess(data.message || 'User updated successfully');
                    // Reload page after 1.5 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showEditError(data.message || 'Failed to update user');
                }
            } catch (error) {
                showEditError('Error updating user: ' + error.message);
            } finally {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
            }
        });
        
        // Group Modal Functions
        function showGroupModal(userId, username, userGroupIds) {
            document.getElementById('modalUsername').textContent = username;
            // Update form action with current user ID
            const form = document.getElementById('groupForm');
            const baseUrl = '{% url "admin_assign_user_group" 999 %}'.replace('999', userId.toString());
            form.action = baseUrl;
            
            // Update checkboxes based on user's current groups
            const checkboxes = document.querySelectorAll('.group-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = userGroupIds.includes(parseInt(checkbox.value));
            });
            
            document.getElementById('groupModal').classList.remove('hidden');
        }
        
        function closeGroupModal() {
            document.getElementById('groupModal').classList.add('hidden');
        }
        
        // Close modals on outside click
        document.addEventListener('DOMContentLoaded', function() {
            const createModal = document.getElementById('createUserModal');
            const editModal = document.getElementById('editUserModal');
            const groupModal = document.getElementById('groupModal');
            
            if (createModal) {
                createModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeCreateModal();
                    }
                });
            }
            
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeEditModal();
                    }
                });
            }
            
            if (groupModal) {
                groupModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeGroupModal();
                    }
                });
            }
        });
    </script>
</div>
{% endblock %}

